{{extend 'layout.html'}}

{{block page_js}}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Get the edit equipment button
    const editEquipmentBtn = document.getElementById("editEquipmentBtn");

    // Attach event listener
    if (editEquipmentBtn) {
      editEquipmentBtn.addEventListener("click", function() {
        // Get the equipment ID from the server
        const equipmentId = "{{=equipment.id}}";
      if (equipmentId) {
        alert("WE HAVE EQUIPMENT ID" +equipmentId);
        console.log("Fetching details for equipment ID:", equipmentId); // ADD THIS
        fetch(`${URLs.detailsPrefix}/${equipmentId}.json`)
          .then((response) => {
            console.log("Response status:", response.status); // ADD THIS
            return response.json();
          })
          .then((data) => {
            console.log("Data received:", data); // ADD THIS
            if (data && data.equipment) {
              const equipment = data.equipment;

              // Populate form fields with existing data
              Object.keys(equipment).forEach((key) => {
                const field = modal.querySelector(`#${key}`);
                if (field) {
                  if (field.tagName === "SELECT") {
                    field.value = equipment[key] || "";
                  } else if (field.type === "date") {
                    // Format date as YYYY-MM-DD for input[type="date"]
                    if (equipment[key]) {
                      const date = new Date(equipment[key]);
                      const year = date.getFullYear();
                      const month = (date.getMonth() + 1)
                        .toString()
                        .padStart(2, "0");
                      const day = date.getDate().toString().padStart(2, "0");
                      field.value = `${year}-${month}-${day}`;
                    }
                  } else {
                    field.value = equipment[key] || "";
                  }
                }
              });

              // Trigger change event on site location to load related equipment locations
              if (equipment.site_location) {
                const event = new Event("change");
                siteSelect.dispatchEvent(event);
              }
            }
          });
      }

      });
    }
  });

<script src="{{=URL('static', 'js/manage_equipment.js')}}"></script>
{{end page_js}}

<div class="maintenance-transformer-detail-page">
  <!-- Sub-Header with Breadcrumbs -->
  <div class="sub-header">
    <a href="{{=URL('equipment', 'manage_equipment')}}">
      < {{=equipment_category.name if equipment_category else 'N/A'}} / {{=equipment.manufacturer_serial}}
    </a>
    <div class="documentation">
      Documentation <i class="fas fa-book"></i>
    </div>
  </div>

  <!-- Equipment Details Section -->
  <div class="equipment-details">
    <h2>Equipment Details</h2>
    <div class="edit-equipment" id="editEquipmentBtn">
      Edit Equipment <i class="fas fa-pencil-alt"></i>
    </div>

    <div class="details-grid">
      <div class="detail-item">
        Type: <span>{{=equipment.name if equipment.name else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Serial #: <span>{{=equipment.manufacturer_serial if equipment.manufacturer_serial else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Asset Tag: <span>{{=equipment.soluna_asset_tag if equipment.soluna_asset_tag else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Manuf. Date: <span>{{=equipment.created_on.strftime('%Y-%m-%d') if equipment.created_on else 'N/A'}}</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Required Maintenance Section -->
    <div class="required-maintenance">
      <h3>Required Maintenance</h3>
      <table>
        <thead>
          <tr>
            <th>Activity</th>
            <th>Last Completed</th>
            <th>Upcoming</th>
          </tr>
        </thead>
        <tbody>
            <tr>
              <td colspan="3">No maintenance schedule found for this equipment.</td>
            </tr>
        </tbody>
      </table>
    </div>

    <!-- Report Section -->
    <div class="report">
      <div class="report-header">
        <h3>Report</h3>
        <button class="new-report-btn">New Report</button>
      </div>
      <div class="report-details">
        <h4>Report Details</h4>
        <div class="report-name">
          Report Name
        </div>
        <div class="edit-report">
          Edit Report <i class="fas fa-pencil-alt"></i>
        </div>

        <div class="report-grid">
          <div class="report-item">
            Report Type: <span>Report Type</span>
          </div>
          <div class="report-item">
            Action Status: <span>Action Status</span>
          </div>
          <div class="report-item">
            Report Date: <span>Report Date</span>
          </div>
          <div class="report-item">
            DGA Due: <span>DGA Due</span>
          </div>
          <div class="report-item">
            Test Data: <span>Test Data</span>
          </div>
          <div class="report-item">
            Due Action: <span>Due Action</span>
          </div>
          <div class="report-item">
            Location: <span>Location</span>
          </div>
          <div class="report-item">
            Report by: <span>Report by</span>
          </div>
        </div>
        <div class="report-note">
          Note
        </div>

        <!-- Add Attachment -->
        <button class="add-attachment-btn" id="addAttachmentBtn">
          + Add Attachment
        </button>
      </div>
    </div>

    <!-- Report History Section -->
    <div class="report-history">
      <div class="report-history-header">
        <h3>Report History</h3>
        <div class="report-history-options">
          2024 <i class="fas fa-caret-down"></i>
          <i class="fas fa-sort-amount-down"></i>
        </div>
      </div>
      <div class="report-history-list">
        <div class="report-history-item">
          DGA DV 09/06/2024 #R4
        </div>
        <div class="report-history-item">
          Torque Spec DV 09/06/2024 #R3
        </div>
        <div class="report-history-item">
          Oil Change DV 06/22/2024 #R2
        </div>
        <div class="report-history-item">
          Bushing Repair DV 04/27/2024 #R1
        </div>
      </div>
    </div>
  </div>

  <!-- Active Items Section -->
  <div class="active-items">
    <h3>Active Items</h3>
    <div class="active-item">
      Active Item
      <div class="item-details">
        Item: T-R/A-3 Customer: Bit Digital Est. Downtime: N/A Outstanding: <a href="#">Attach Analysis</a>
      </div>
    </div>
  </div>
</div>
