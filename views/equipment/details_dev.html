{{extend 'layout.html'}}

{{block page_js}}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Get the edit equipment button
    const editEquipmentBtn = document.getElementById("editEquipmentBtn");

    // Get the equipment ID from the server
    const equipmentId = "{{=equipment.id}}";

    // Add these URL variables for use in JavaScript
    const URLs = {
      getEquipmentData: "{{=URL('equipment', 'get_equipment_data')}}",
      getReferenceData: "{{=URL('equipment', 'get_reference_data')}}",
      addEquipment: "{{=URL('equipment', 'add_equipment')}}",
      deleteEquipment: "{{=URL('equipment', 'delete_equipment')}}",
      detailsPrefix: "{{=URL('equipment', 'details')}}"
    };

    //Attach the test call before proceeding to load more
    console.log("Are there any problems getting URLS before the action?",URLs);

        /**
       * Display a message to the user
       */
      function showMessage(message, type = "info") {
        // Create alert element
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = "alert";
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Find container to show message
        const container = document.querySelector(".equipment-overview-container");
        container.insertBefore(alertDiv, container.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
          alert.close();
        }, 5000);
      }
                
      /**
       * Show equipment add/edit modal
       */
      function showEquipmentModal(equipmentId = null) {
        // First, load reference data for dropdowns
        fetch('{{=URL('equipment', 'get_reference_data')}}')
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              createAndShowModal(data, equipmentId);
            } else {
              showMessage(
                "Error loading reference data: " + (data.message || "Unknown error"),
                "error"
              );
            }
          })
          .catch((error) => {
            console.error("Error fetching reference data:", error);
            showMessage("Failed to load reference data", "error");
          });
      }

      /**
       * Create and show the equipment modal with form
       */
      function createAndShowModal(referenceData, equipmentId) {
        // Remove any existing modal
        const existingModal = document.getElementById("equipmentModal");
        if (existingModal) {
          existingModal.remove();
        }

        // Create modal structure
        const modal = document.createElement("div");
        modal.className = "modal fade";
        modal.id = "equipmentModal";
        modal.tabIndex = -1;
        modal.setAttribute("aria-labelledby", "equipmentModalLabel");
        modal.setAttribute("aria-hidden", "true");

        const title = equipmentId ? "Edit Equipment" : "Add New Equipment";

        modal.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="equipmentModalLabel">${title}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="equipmentForm">
                  <input type="hidden" id="equipment_id" name="id" value="${
                    equipmentId || ""
                  }">
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="name" class="form-label">Equipment Name*</label>
                      <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    <div class="col-md-6">
                      <label for="category" class="form-label">Category*</label>
                      <select class="form-select" id="category" name="category" required>
                        <option value="">Select Category</option>
                        ${referenceData.categories
                          .map(
                            (cat) =>
                              `<option value="${cat.id}">${cat.name}</option>`
                          )
                          .join("")}
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="manufacturer_serial" class="form-label">Manufacturer Serial</label>
                      <input type="text" class="form-control" id="manufacturer_serial" name="manufacturer_serial">
                    </div>
                    <div class="col-md-6">
                      <label for="soluna_asset_tag" class="form-label">Asset Tag</label>
                      <input type="text" class="form-control" id="soluna_asset_tag" name="soluna_asset_tag">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="site_location" class="form-label">Site Location</label>
                      <select class="form-select" id="site_location" name="site_location">
                        <option value="">Select Site</option>
                        ${referenceData.site_locations
                          .map(
                            (site) =>
                              `<option value="${site.id}">${site.name}</option>`
                          )
                          .join("")}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="equipment_location" class="form-label">Equipment Location</label>
                      <select class="form-select" id="equipment_location" name="equipment_location">
                        <option value="">Select Location</option>
                        ${referenceData.equipment_locations
                          .map(
                            (loc) =>
                              `<option value="${loc.id}">${loc.name}</option>`
                          )
                          .join("")}
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="warranty_details" class="form-label">Warranty Details</label>
                      <textarea class="form-control" id="warranty_details" name="warranty_details" rows="3"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="installed_upgrades" class="form-label">Installed Upgrades</label>
                      <textarea class="form-control" id="installed_upgrades" name="installed_upgrades" rows="3"></textarea>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="power_ratings" class="form-label">Power Ratings</label>
                      <input type="text" class="form-control" id="power_ratings" name="power_ratings">
                    </div>
                    <div class="col-md-6">
                      <label for="trip_setpoints" class="form-label">Trip Setpoints</label>
                      <input type="text" class="form-control" id="trip_setpoints" name="trip_setpoints">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="dga_due" class="form-label">DGA Due Date</label>
                      <input type="date" class="form-control" id="dga_due" name="dga_due">
                    </div>
                    <div class="col-md-6">
                      <label for="item_due_date" class="form-label">Item Due Date</label>
                      <input type="date" class="form-control" id="item_due_date" name="item_due_date">
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="active_items" class="form-label">Active Items</label>
                      <input type="text" class="form-control" id="active_items" name="active_items">
                    </div>
                    <div class="col-md-6">
                      <label for="item_status" class="form-label">Item Status</label>
                      <input type="text" class="form-control" id="item_status" name="item_status">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEquipment">Save</button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Initialize modal
        const modalElement = new bootstrap.Modal(
          document.getElementById("equipmentModal")
        );

        // Set up site location change event to filter equipment locations
        const siteSelect = modal.querySelector("#site_location");
        const locationSelect = modal.querySelector("#equipment_location");

        siteSelect.addEventListener("change", () => {
          const siteId = siteSelect.value;
          if (siteId) {
            // Filter equipment locations based on selected site
            fetch(`${URLs.getReferenceData}?site_id=${siteId}`)
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  // Refresh equipment locations dropdown
                  locationSelect.innerHTML =
                    '<option value="">Select Location</option>';
                  data.equipment_locations.forEach((loc) => {
                    const option = document.createElement("option");
                    option.value = loc.id;
                    option.textContent = loc.name;
                    locationSelect.appendChild(option);
                  });
                }
              });
          } else {
            // Reset equipment locations dropdown
            locationSelect.innerHTML = '<option value="">Select Location</option>';
            referenceData.equipment_locations.forEach((loc) => {
              const option = document.createElement("option");
              option.value = loc.id;
              option.textContent = loc.name;
              locationSelect.appendChild(option);
            });
          }
        });

        // If editing, load existing equipment data
        if (equipmentId) {
          console.log("Now Fetch the info of what is being pushed in, to see at what point is this breaking" )
          fetch(`${URLs.detailsPrefix}/${equipmentId}.json`)
            .then((response) => {
              console.log("Line725");
              console.log("Check Response here:", response);
              return response.json();
            })
            .then((data) => {
              console.log("L731:Check Data to make sure all code has loaded:", data)
              if (data && data.equipment) {
                const equipment = data.equipment;

                // Populate form fields with existing data
                Object.keys(equipment).forEach((key) => {
                  const field = modal.querySelector(`#${key}`);
                  if (field) {
                    if (field.tagName === "SELECT") {
                      field.value = equipment[key] || "";
                    } else if (field.type === "date") {
                      // Format date as YYYY-MM-DD for input[type="date"]
                      if (equipment[key]) {
                        const date = new Date(equipment[key]);
                        const year = date.getFullYear();
                        const month = (date.getMonth() + 1)
                          .toString()
                          .padStart(2, "0");
                        const day = date.getDate().toString().padStart(2, "0");
                        field.value = `${year}-${month}-${day}`;
                      }
                    } else {
                      field.value = equipment[key] || "";
                    }
                  }
                });

                // Trigger change event on site location to load related equipment locations
                if (equipment.site_location) {
                  const event = new Event("change");
                  siteSelect.dispatchEvent(event);
                }
              }
            });
        }

        // Set up save button
        const saveButton = modal.querySelector("#saveEquipment");
        saveButton.addEventListener("click", () => {
          saveEquipment(modal);
        });

        modalElement.show();
      }

      /**
       * Save equipment data
       */
      function saveEquipment(modal) {
        const form = modal.querySelector("#equipmentForm");

        // Basic form validation
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // Collect form data
        const formData = new FormData(form);

        // Send data to server
        fetch('{{=URLs.addEquipment}}', {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // Close modal
              const modalElement = bootstrap.Modal.getInstance(modal);
              modalElement.hide();

              // Show success message
              showMessage(data.message, "success");

              // Reload equipment data
              //loadEquipmentData(); <=== DO NOT LOAD ON DETAILS
            } else {
              showMessage(data.message || "Error saving equipment", "error");
            }
          })
          .catch((error) => {
            console.error("Error saving equipment:", error);
            showMessage("Failed to save equipment", "error");
          });
      }

    // Attach event listener
    const editEquipmentBtn = document.getElementById("editEquipmentBtn");
    if (editEquipmentBtn) {
      editEquipmentBtn.addEventListener("click", function() {
        console.log("Running from Top now 4. Load modal!");
        // Get the equipment ID from the server
        const equipmentId = "{{=equipment.id}}";

        showEquipmentModal(equipmentId);
      });
    }
  });
</script>
{{end page_js}}

<div class="maintenance-transformer-detail-page">
  <!-- Sub-Header with Breadcrumbs -->
  <div class="sub-header">
    <a href="{{=URL('equipment', 'manage_equipment')}}">
      < {{=equipment_category.name if equipment_category else 'N/A'}} / {{=equipment.manufacturer_serial}}
    </a>
    <div class="documentation">
      Documentation <i class="fas fa-book"></i>
    </div>
  </div>

  <!-- Equipment Details Section -->
  <div class="equipment-details">
    <h2>Equipment Details</h2>
    <div class="edit-equipment" id="editEquipmentBtn">
      Edit Equipment <i class="fas fa-pencil-alt"></i>
    </div>

    <div class="details-grid">
      <div class="detail-item">
        Type: <span>{{=equipment.name if equipment.name else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Serial #: <span>{{=equipment.manufacturer_serial if equipment.manufacturer_serial else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Asset Tag: <span>{{=equipment.soluna_asset_tag if equipment.soluna_asset_tag else 'N/A'}}</span>
      </div>
      <div class="detail-item">
        Manuf. Date: <span>{{=equipment.created_on.strftime('%Y-%m-%d') if equipment.created_on else 'N/A'}}</span>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Required Maintenance Section -->
    <div class="required-maintenance">
      <h3>Required Maintenance</h3>
      <table>
        <thead>
          <tr>
            <th>Activity</th>
            <th>Last Completed</th>
            <th>Upcoming</th>
          </tr>
        </thead>
        <tbody>
          {{if maintenance_schedule:}}
            {{for item in maintenance_schedule:}}
              <tr>
                <td>{{=item['activity']}}</td>
                <td>{{=item['last_completed']}}</td>
                <td>{{=item['upcoming']}}</td>
              </tr>
            {{pass}}
          {{else:}}
            <tr>
              <td colspan="3">No maintenance schedule found for this equipment.</td>
            </tr>
          {{pass}}
        </tbody>
      </table>
    </div>

    <!-- Report Section -->
    <div class="report">
      <div class="report-header">
        <h3>Report</h3>
        <button class="new-report-btn">New Report</button>
      </div>
      <div class="report-details">
        <h4>Report Details</h4>
        <div class="report-name">
          Report Name
        </div>
        <div class="edit-report">
          Edit Report <i class="fas fa-pencil-alt"></i>
        </div>

        <div class="report-grid">
          <div class="report-item">
            Report Type: <span>Report Type</span>
          </div>
          <div class="report-item">
            Action Status: <span>Action Status</span>
          </div>
          <div class="report-item">
            Report Date: <span>Report Date</span>
          </div>
          <div class="report-item">
            DGA Due: <span>DGA Due</span>
          </div>
          <div class="report-item">
            Test Data: <span>Test Data</span>
          </div>
          <div class="report-item">
            Due Action: <span>Due Action</span>
          </div>
          <div class="report-item">
            Location: <span>Location</span>
          </div>
          <div class="report-item">
            Report by: <span>Report by</span>
          </div>
        </div>
        <div class="report-note">
          Note
        </div>

        <!-- Add Attachment -->
        <button class="add-attachment-btn" id="addAttachmentBtn">
          + Add Attachment
        </button>
      </div>
    </div>

    <!-- Report History Section -->
    <div class="report-history">
      <div class="report-history-header">
        <h3>Report History</h3>
        <div class="report-history-options">
          2024 <i class="fas fa-caret-down"></i>
          <i class="fas fa-sort-amount-down"></i>
        </div>
      </div>
      <div class="report-history-list">
        <div class="report-history-item">
          DGA DV 09/06/2024 #R4
        </div>
        <div class="report-history-item">
          Torque Spec DV 09/06/2024 #R3
        </div>
        <div class="report-history-item">
          Oil Change DV 06/22/2024 #R2
        </div>
        <div class="report-history-item">
          Bushing Repair DV 04/27/2024 #R1
        </div>
      </div>
    </div>
  </div>

  <!-- Active Items Section -->
  <div class="active-items">
    <h3>Active Items</h3>
    <div class="active-item">
      Active Item
      <div class="item-details">
        Item: T-R/A-3 Customer: Bit Digital Est. Downtime: N/A Outstanding: <a href="#">Attach Analysis</a>
      </div>
    </div>
  </div>
</div>
