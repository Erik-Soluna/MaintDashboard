{{extend 'layout.html'}}

<h1>Maintenance Calendar</h1>

<!-- âœ… Ensure Shared Modal is Included -->
<div id="modal-container">
  {{include 'default/shared_modal.html'}}
</div>

<!-- Schedule Add Item Modal -->
<div
  class="modal fade"
  id="scheduleAddItemModal"
  tabindex="-1"
  aria-labelledby="scheduleAddItemModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleAddItemModalLabel">
          Schedule Add Item
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="scheduleAddItemForm">
          <div class="mb-3">
            <i class="fas fa-bell"></i>
            <label for="itemTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="itemTitle" />
          </div>
          <div class="mb-3">
            <i class="fas fa-list"></i>
            <label for="itemType" class="form-label">Item Type</label>
            <select class="form-control" id="itemType">
              <option>Maintenance Item</option>
              <option>Inspection</option>
              <!-- Add more options as needed -->
            </select>
          </div>
          <div class="mb-3">
            <i class="fas fa-file-alt"></i>
            <label for="itemDescription" class="form-label">Description</label>
            <textarea class="form-control" id="itemDescription"></textarea>
          </div>
          <div class="mb-3">
            <i class="fas fa-clock"></i>
            <label class="form-label">Time</label>
            <div class="row">
              <div class="col-md-6">
                <input type="date" class="form-control" id="itemDate" />
              </div>
              <div class="col-md-6">
                <input type="time" class="form-control" id="itemTime" />
              </div>
            </div>
          </div>
          <div class="mb-3">
            <i class="fas fa-user"></i>
            <label for="itemAssignedTo" class="form-label">Assigned To</label>
            <select class="form-control" id="itemAssignedTo">
              <option>Nathan Marshall</option>
              <!-- Add more options as needed -->
            </select>
          </div>
          <div class="mb-3">
            <i class="fas fa-redo"></i>
            <label for="itemRecurrence" class="form-label">Recurrence</label>
            <select class="form-control" id="itemRecurrence">
              <option>Never</option>
              <option>Daily</option>
              <option>Weekly</option>
              <option>Monthly</option>
              <option>Yearly</option>
              <!-- Add more options as needed -->
            </select>
          </div>
          <div class="mb-3">
            <i class="fas fa-exclamation-triangle"></i>
            <label for="itemPriority" class="form-label">Priority</label>
            <select class="form-control" id="itemPriority">
              <option>High</option>
              <option>Medium</option>
              <option>Low</option>
              <!-- Add more options as needed -->
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Calendar Container -->
<div id="calendar-container">
  <div id="calendar"></div>
</div>

<style>
  body {
    overflow-x: hidden;
  }

  #calendar-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    height: calc(100vh - 120px);
    min-height: 500px;
    overflow: hidden;
  }

  #calendar {
    width: 100%;
    height: 100%;
  }

  .fc-toolbar-title {
    cursor: pointer;
    font-weight: bold;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("Initializing FullCalendar...");

  if (typeof FullCalendar === "undefined") {
    console.error(
      "Error: FullCalendar is not loaded. Check if layout.html includes it."
    );
    showFlashMessage(
      "Error: FullCalendar failed to load. Try refreshing the page.",
      "danger"
    );
    return;
  }

  const calendarEl = document.getElementById("calendar");
  if (!calendarEl) {
    console.error("Error: Calendar element not found in the DOM.");
    showFlashMessage("Error: Calendar could not be initialized.", "danger");
    return;
  }

  console.log("Creating FullCalendar instance...");
  try {
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      editable: true,
      events: '{{=URL("events", "fetch_events")}}',
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },

      dateClick: function (info) {
        console.log("Date Clicked:", info.dateStr);
        // Show the modal here
        const scheduleAddItemModal = new bootstrap.Modal(document.getElementById('scheduleAddItemModal'));
        scheduleAddItemModal.show();

        if (typeof resetModalForNewEvent === "function") {
          resetModalForNewEvent(info.dateStr);
        } else {
          console.warn("resetModalForNewEvent is not defined!");
        }
      },

      eventClick: function (info) {
        console.log("Event Clicked:", info.event.id);

        fetch('{{=URL("events", "get_event")}}?id=' + info.event.id)
          .then((response) => response.json())
          .then((data) => {
            console.log("API Response:", data);
            if (data.status === "success") {
              if (typeof loadEventIntoModal === "function") {
                loadEventIntoModal(data);
              } else {
                console.error("loadEventIntoModal is not defined!");
                showFlashMessage(
                  "Error: Cannot load event details.",
                  "danger"
                );
              }
            } else {
              showFlashMessage(
                "Error loading event details: " + data.message,
                "danger"
              );
            }
          })
          .catch((error) =>
            showFlashMessage(
              "Error fetching event details: " + error,
              "danger"
            )
          );
      }
    });

    console.log("Rendering FullCalendar...");
    calendar.render();
    console.log("FullCalendar rendered successfully!");
  } catch (error) {
    console.error("FullCalendar Initialization Error:", error);
    showFlashMessage("Error: FullCalendar failed to initialize.", "danger");
  }
});
</script>
