{{extend 'layout.html'}}

<h1>Maintenance Calendar</h1>

<!-- âœ… Ensure Shared Modal is Included -->
<div id="modal-container">
  {{include 'default/shared_modal.html'}}
</div>

<!-- Calendar Container -->
<div id="calendar-container">
  <div id="calendar"></div>
</div>

<style>
  body {
    overflow-x: hidden;
  }

  #calendar-container {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    height: calc(100vh - 120px);
    min-height: 500px;
    overflow: hidden;
  }

  #calendar {
    width: 100%;
    height: 100%;
  }

  .fc-toolbar-title {
    cursor: pointer;
    font-weight: bold;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("Initializing FullCalendar...");

  if (typeof FullCalendar === "undefined") {
    console.error(
      "Error: FullCalendar is not loaded. Check if layout.html includes it."
    );
    showFlashMessage(
      "Error: FullCalendar failed to load. Try refreshing the page.",
      "danger"
    );
    return;
  }

  const calendarEl = document.getElementById("calendar");
  if (!calendarEl) {
    console.error("Error: Calendar element not found in the DOM.");
    showFlashMessage("Error: Calendar could not be initialized.", "danger");
    return;
  }

  console.log("Creating FullCalendar instance...");
  try {
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      selectable: true,
      editable: true,
      events: '{{=URL("events", "fetch_events")}}',
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },

      dateClick: function (info) {
        console.log("Date Clicked:", info.dateStr);
        if (typeof resetModalForNewEvent === "function") {
          resetModalForNewEvent(info.dateStr);
        } else {
          console.error("resetModalForNewEvent is not defined!");
          showFlashMessage(
            "Error: Cannot open event creation modal.",
            "danger"
          );
        }
      },

      eventClick: function (info) {
        console.log("Event Clicked:", info.event.id);

        fetch('{{=URL("events", "get_event")}}?id=' + info.event.id)
          .then((response) => response.json())
          .then((data) => {
            console.log("API Response:", data);
            if (data.status === "success") {
              if (typeof loadEventIntoModal === "function") {
                loadEventIntoModal(data);
              } else {
                console.error("loadEventIntoModal is not defined!");
                showFlashMessage(
                  "Error: Cannot load event details.",
                  "danger"
                );
              }
            } else {
              showFlashMessage(
                "Error loading event details: " + data.message,
                "danger"
              );
            }
          })
          .catch((error) =>
            showFlashMessage(
              "Error fetching event details: " + error,
              "danger"
            )
          );
      }
    });

    console.log("Rendering FullCalendar...");
    calendar.render();
    console.log("FullCalendar rendered successfully!");
  } catch (error) {
    console.error("FullCalendar Initialization Error:", error);
    showFlashMessage("Error: FullCalendar failed to initialize.", "danger");
  }
});
</script>
