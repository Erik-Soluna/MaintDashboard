{{extend 'layout.html'}}

<h1>Manage Settings</h1>

<!-- Flash Messages Container -->
<div id="flash-message"></div>

<!-- Settings Navigation -->
<ul class="nav nav-tabs" id="settingsTabs">
  <li class="nav-item">
    <a class="nav-link active" id="general-tab" data-bs-toggle="tab"
      href="#generalSettings">General</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="location-tab" data-bs-toggle="tab"
      href="#locationSettings">Locations</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="category-tab" data-bs-toggle="tab"
      href="#categorySettings">Equipment Categories</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="user-tab" data-bs-toggle="tab"
      href="#userSettings">User Preferences</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="admin-tab" data-bs-toggle="tab"
      href="#adminSettings">User Management</a>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- General Settings -->
  <div class="tab-pane fade show active" id="generalSettings">
    <h3>General Settings</h3>
    <p>Configure general application settings here.</p>
    <!-- General settings content goes here -->
  </div>

  <!-- Locations -->
  <div class="tab-pane fade" id="locationSettings">
    <h3>Locations</h3>
    <p>Manage site and equipment locations.</p>

    <!-- Add Location Form -->
    <h4>Add Location</h4>
    <form id="addLocationForm">
      <div class="mb-3">
        <label for="locationName" class="form-label">Location Name</label>
        <input type="text" class="form-control" id="locationName"
          name="location_name" required>
      </div>
      <div class="mb-3">
        <label for="parentLocation" class="form-label">Parent Location
          (Site)</label>
        <select class="form-select" id="parentLocation"
          name="parent_location_id">
          <option value="">Select Site (if equipment location)</option>
          {{for location in locations:}}
          {{if location.is_site:}}
          <option value="{{=location.id}}">{{=location.name}}</option>
          {{pass}}
          {{pass}}
        </select>
      </div>
      <div class="mb-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="isSite"
            name="is_site" value="true">
          <label class="form-check-label" for="isSite">Is Site Location?</label>
        </div>
      </div>
      <input type="hidden" name="_formkey" value="{{=formkey}}">
      <button type="button" class="btn btn-primary" id="addLocationBtn">Add
        Location</button>
    </form>

    <!-- Location Display (Nested) -->
    <h4>Existing Locations</h4>
    {{def display_locations(parent_id=None, indent=0):}}
    <ul>
      {{for location in locations:}}
      {{if location.parent_location == parent_id:}}
      <li style="margin-left: {{=indent}}em;">
        {{=location.name}}
        {{if location.is_site:}}
        (Site)
        {{else:}}
        (Equipment)
        {{pass}}
        <button class="btn btn-sm btn-danger deleteLocationBtn"
          data-location-id="{{=location.id}}">Delete</button>
        {{display_locations(parent_id=location.id, indent=indent + 2)}}
      </li>
      {{pass}}
      {{pass}}
    </ul>
    {{pass}}

    {{display_locations()}}
  </div>

  <!-- Categories -->
  <div class="tab-pane fade" id="categorySettings">
    <h3>Equipment Categories</h3>
    <p>Manage equipment categories.</p>

    <!-- Add Category Form -->
    <h4>Add Category</h4>
    <form id="addCategoryForm">
      <div class="mb-3">
        <label for="categoryName" class="form-label">Category Name</label>
        <input type="text" class="form-control" id="categoryName"
          name="category_name" required>
      </div>
      <input type="hidden" name="_formkey" value="{{=formkey}}">
      <button type="button" class="btn btn-primary" id="addCategoryBtn">Add
        Category</button>
    </form>

    <!-- Category Table -->
    <h4>Existing Categories</h4>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {{for category in categories:}}
        <tr>
          <td>{{=category.id}}</td>
          <td>{{=category.name}}</td>
          <td>
            <button class="btn btn-sm btn-danger deleteCategoryBtn"
              data-category-id="{{=category.id}}">Delete</button>
          </td>
        </tr>
        {{pass}}
      </tbody>
    </table>
  </div>

  <!-- User Preferences -->
  <div class="tab-pane fade" id="userSettings">
    <h3>User Preferences</h3>
    <p>Set user-specific preferences.</p>
    <!-- User preferences content goes here -->
  </div>

  <!-- User Management (Admin Only) -->
  <div class="tab-pane fade" id="adminSettings">
    <h3>Manage Users</h3>
    <p>Below is a table of users where you can edit roles or remove users.</p>

    <!-- Add New User Button -->
    <a href="{{=URL('settings', 'edit_user', args=['new'])}}"
      class="btn btn-primary mb-3">Add New User</a>

    <!-- User Role Update Form -->
    <form method="post" action="{{=URL('settings', 'manage_user_parameters')}}">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>User ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Group</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{for user in users:}}
          <tr>
            <td>{{=user.id}}</td>
            <td>{{=user.first_name}}</td>
            <td>{{=user.last_name}}</td>
            <td>{{=user.last_name}}</td>
            <td>{{=user.email}}</td>
            <td>
              <select name="groupID_{{=user.id}}" class="form-control">
                {{for group in db(db.auth_group).select():}}
                <option value="{{=group.id}}" {{='selected' if
                  hasattr(user, 'groupID') and user.groupID == group.id else
                  ''}}>
                  {{=group.role}}
                </option>
                {{pass}}
              </select>
            </td>
            <td>
              <button type="submit" name="update_user" value="{{=user.id}}"
                class="btn btn-sm btn-secondary">Update</button>
            </td>
          </tr>
          {{pass}}
        </tbody>
      </table>
    </form>

    <!-- Bulk Delete Form -->
    <form id="bulkDeleteForm" method="post"
      action="{{=URL('settings', 'bulk_delete_users')}}">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>User ID</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {{for user in users:}}
          <tr>
            <td><input type="checkbox" name="user_ids" value="{{=user.id}}"></td>
            <td>{{=user.id}}</td>
            <td>{{=user.first_name}}</td>
            <td>{{=user.last_name}}</td>
            <td>{{=user.email}}</td>
            <td>
              <a href="{{=URL('settings', 'edit_user', args=[user.id])}}"
                class="btn btn-sm btn-primary">Edit</a>
            </td>
          </tr>
          {{pass}}
        </tbody>
      </table>
      <button type="submit" class="btn btn-danger">Delete Selected
        Users</button>
    </form>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
  var formkey = "{{=formkey}}";

  // Function to handle AJAX requests
  function handleAjax(url, data, successMessage, tabAnchor) {
    data['_formkey'] = formkey;
    $.ajax({
      url: url,
      method: 'POST',
      data: data,
      dataType: 'json',
      success: function(response) {
        if (response.status === 'success') {
          $('#flash-message').html('<div class="alert alert-success">' +
            successMessage + '</div>');
          setTimeout(function() {
            window.location.reload(); // Reload the page to reflect changes
          }, 1500); // Wait for 1.5 seconds before reloading
        } else {
          $('#flash-message').html('<div class="alert alert-danger">' +
            response.message + '</div>');
        }
      },
      error: function(jqXHR, textStatus, errorThrown) {
        console.error('AJAX error:', textStatus, errorThrown);
        $('#flash-message').html(
          '<div class="alert alert-danger">An unexpected error occurred. Please check the console for details.</div>'
        );
      }
    });
  }

  // Add Location
  $('#addLocationBtn').click(function() {
    var locationName = $('#locationName').val();
    var parentLocationId = $('#parentLocation').val();
    var isSite = $('#isSite').is(':checked');

    handleAjax(
      "{{=URL('settings', 'add_location')}}", {
        location_name: locationName,
        parent_location_id: parentLocationId,
        is_site: isSite
      },
      "Location added successfully.",
      'locationSettings'
    );
  });

  // Delete Location
  $('.deleteLocationBtn').click(function() {
    var locationId = $(this).data('location-id');
    handleAjax(
      "{{=URL('settings', 'delete_location')}}", {
        location_id: locationId
      },
      "Location deleted successfully.",
      'locationSettings'
    );
  });

  // Add Category
  $('#addCategoryBtn').click(function() {
    var categoryName = $('#categoryName').val();
    handleAjax(
      "{{=URL('settings', 'add_category')}}", {
        category_name: categoryName
      },
      "Category added successfully.",
      'categorySettings'
    );
  });

  // Delete Category
  $('.deleteCategoryBtn').click(function() {
    var categoryId = $(this).data('category-id');
    handleAjax(
      "{{=URL('settings', 'delete_category')}}", {
        category_id: categoryId
      },
      "Category deleted successfully.",
      'categorySettings'
    );
  });

  // Ensure selectAll checkbox works for User Management
  document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    for (const checkbox of checkboxes) {
      checkbox.checked = this.checked;
    }
  });
});
</script>
