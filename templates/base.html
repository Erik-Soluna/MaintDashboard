{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>{% block title %}{{ window_title_prefix }}{% if window_title_prefix and window_title_prefix|length > 0 %} {% endif %}{{ site_name }}{% if window_title_suffix and window_title_suffix|length > 0 %} {% endif %}{{ window_title_suffix }}{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    
    <!-- Bootstrap 4 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
    
         <!-- Custom CSS -->
     <link href="{% static 'css/custom.css' %}" rel="stylesheet">
     
     <!-- Custom Branding CSS -->
     {% if custom_css %}
     <style>
         {{ custom_css|safe }}
     </style>
     {% endif %}
    
    {% block extra_css %}{% endblock %}
    
    <style>
        :root {
             --primary-color: {{ primary_color }};
             --secondary-color: {{ secondary_color }};
             --accent-color: {{ accent_color }};
             --success-color: {{ success_color }};
             --warning-color: {{ warning_color }};
             --danger-color: {{ danger_color }};
             --info-color: {{ info_color }};
             --light-color: #e2e8f0;
             --dark-color: #1a2238;
             --darker-color: #0f1419;
             
             /* Header and navigation colors */
             --header-bg: {{ header_background_color }};
             --header-text: {{ header_text_color }};
             --header-border: {{ header_border_color }};
             --nav-bg: {{ navigation_background_color }};
             --nav-text: {{ navigation_text_color }};
             --nav-hover: {{ navigation_hover_color }};
             
             /* Content area colors */
             --content-bg: {{ content_background_color }};
             --content-text: {{ content_text_color }};
             --card-bg: {{ card_background_color }};
             --card-border: {{ card_border_color }};
             
             /* Button and form colors */
             --btn-primary-bg: {{ button_primary_color }};
             --btn-primary-text: {{ button_primary_text_color }};
             --btn-secondary-bg: {{ button_secondary_color }};
             --btn-secondary-text: {{ button_secondary_text_color }};
             --form-bg: {{ form_background_color }};
             --form-border: {{ form_border_color }};
             --form-text: {{ form_text_color }};
         }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: var(--content-bg);
            color: var(--content-text);
        }
        
        /* Dark Theme (Default) */
        body, body.theme-dark {
            background-color: var(--content-bg);
            color: var(--content-text);
        }
        
        /* Light Theme */
        body.theme-light {
            background-color: #f7fafc;
            color: #2d3748;
        }
        
        /* Light Theme Variables */
        body.theme-light {
            --bg-primary: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --header-bg: #2d3748;
            --card-bg: #ffffff;
        }
        
        /* Dark Theme Variables */
        body, body.theme-dark {
            --bg-primary: var(--card-bg);
            --bg-secondary: var(--content-bg);
            --bg-tertiary: var(--darker-color);
            --text-primary: var(--content-text);
            --text-secondary: #a0aec0;
            --border-color: var(--card-border);
            --header-bg: var(--header-bg);
            --card-bg: var(--card-bg);
        }

        /* Unified Header Styling */
        .main-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            padding: 15px 20px;
        }
        
        .header-brand {
            font-size: 20px;
            font-weight: bold;
            color: var(--header-text);
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .header-brand:hover {
            color: var(--nav-hover);
            text-decoration: none;
        }
        
        .header-logo {
            height: 40px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }
        
        .brand-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--header-text);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .version-badge {
            font-size: 12px;
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .version-badge small {
            color: #a0aec0 !important;
            font-weight: 500;
        }
        
        .site-selector {
            background-color: #2d3748;
            color: white;
            border: 1px solid #4a5568;
            border-radius: 6px;
            padding: 8px 12px;
        }
        
        .site-selector:focus {
            background-color: #2d3748;
            color: white;
            border-color: #4299e1;
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
        }
        
        /* Navigation Tabs */
        .nav-tabs-custom {
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            padding: 0 20px;
        }
        
        .nav-tabs-custom .nav-link {
            color: var(--text-secondary);
            border: none;
            padding: 15px 25px;
            font-weight: 500;
            background: transparent;
        }
        
        .nav-tabs-custom .nav-link.active {
            color: #4299e1;
            background-color: transparent;
            border-bottom: 2px solid #4299e1;
            font-weight: 600;
        }
        
        .nav-tabs-custom .nav-link:hover {
            color: var(--text-primary);
            background-color: var(--bg-primary);
        }
        
        /* Page Content */
        .main-container {
            background-color: var(--bg-secondary);
            min-height: calc(100vh - 140px);
            padding: 20px;
        }
        
        .page-header {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
        }
        
        .card-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .card-body {
            background-color: var(--card-bg);
        }
        
        .form-control {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .form-control:focus {
            background-color: var(--bg-secondary);
            border-color: #4299e1;
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background-color: #4299e1;
            border-color: #4299e1;
        }
        
        .btn-primary:hover {
            background-color: #3182ce;
            border-color: #3182ce;
        }
        
        .btn-outline-secondary {
            color: #a0aec0;
            border-color: #4a5568;
        }
        
        .btn-outline-secondary:hover {
            background-color: #4a5568;
            border-color: #4a5568;
            color: white;
        }
        
        /* Enhanced Button Styling with Branding Colors */
        .btn-primary {
            background-color: var(--btn-primary-bg);
            border-color: var(--btn-primary-bg);
            color: var(--btn-primary-text);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--btn-primary-text);
        }
        
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            border-color: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--btn-secondary-text);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
            color: white;
        }
        
        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
            color: white;
        }
        
        /* Enhanced Form Styling with Branding Colors */
        .form-control {
            background-color: var(--form-bg);
            color: var(--form-text);
            border: 1px solid var(--form-border);
        }
        
        .form-control:focus {
            background-color: var(--form-bg);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
            color: var(--form-text);
        }
        
        .form-label {
            color: var(--form-text);
            font-weight: 500;
        }
        
        /* Enhanced Card Styling with Branding Colors */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            color: var(--content-text);
        }
        
        .card-header {
            background-color: var(--nav-bg);
            border-bottom: 1px solid var(--card-border);
            color: var(--nav-text);
        }
        
        .card-body {
            background-color: var(--card-bg);
            color: var(--content-text);
        }
        
        /* Enhanced Navigation Styling with Branding Colors */
        .nav-tabs-custom {
            border-bottom: 1px solid var(--card-border);
            background-color: var(--nav-bg);
            padding: 0 20px;
        }
        
        .nav-tabs-custom .nav-link {
            color: var(--nav-text);
            border: none;
            padding: 15px 25px;
            font-weight: 500;
            background: transparent;
        }
        
        .nav-tabs-custom .nav-link.active {
            color: var(--accent-color);
            background-color: transparent;
            border-bottom: 2px solid var(--accent-color);
            font-weight: 600;
        }
        
        .nav-tabs-custom .nav-link:hover {
            color: var(--nav-hover);
            background-color: var(--nav-bg);
        }
        
        /* Enhanced Site Selector with Branding Colors */
        .site-selector {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            border: 1px solid var(--card-border);
            border-radius: 6px;
            padding: 8px 12px;
        }
        
        .site-selector:focus {
            background-color: var(--nav-bg);
            color: var(--nav-text);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
        }
        
        /* Enhanced Table Styling with Branding Colors */
        .table {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
        
        .table th {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .table td {
            border-bottom: 1px solid var(--border-color);
        }
        
        .table-hover tbody tr:hover {
            background-color: var(--bg-tertiary);
        }
        
        .breadcrumb {
            background: transparent;
            padding: 0;
            margin: 0;
        }
        
        .breadcrumb-item a {
            color: #4299e1;
        }
        
        .breadcrumb-item.active {
            color: #a0aec0;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6c757d;
        }
        
        .badge-secondary {
            background-color: #4a5568;
        }
        
        .badge-success {
            background-color: #48bb78;
        }
        
        .badge-warning {
            background-color: #ed8936;
        }
        
        .badge-danger {
            background-color: #f56565;
        }
        
        .badge-primary {
            background-color: #4299e1;
        }
        
        /* Footer */
        .footer {
            background-color: #0f1419;
            color: #a0aec0;
            padding: 20px 0;
            border-top: 1px solid #2d3748;
        }
        
        /* Modal styling */
        .modal-content {
            background-color: #2d3748;
            color: white;
            border: 1px solid #4a5568;
        }
        
        .modal-header {
            border-bottom: 1px solid #4a5568;
        }
        
        .close {
            color: white;
        }
        
        /* Dropdown Menu Fixes */
        .dropdown-menu {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1050;
            min-width: 200px;
            padding: 8px 0;
            position: absolute;
            top: 100%;
            left: 0;
            display: none;
            float: left;
            max-height: 90vh;
            overflow-y: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .dropdown-item {
            color: var(--text-primary);
            padding: 8px 16px;
            transition: background-color 0.2s ease;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .dropdown-item:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .dropdown-item:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .dropdown-divider {
            border-top: 1px solid var(--border-color);
            margin: 8px 0;
        }
        
        /* Ensure dropdowns are not clipped */
        .dropdown {
            position: relative;
        }
        
        .dropdown.show .dropdown-menu {
            display: block;
        }
        
        .dropdown-menu-right {
            right: 0;
            left: auto;
        }
        
        /* Fix for dropdown positioning and overflow */
        .navbar-nav .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 1050;
            float: none;
            min-width: 160px;
            max-width: 300px;
            overflow: visible;
            word-wrap: break-word;
        }
        
        /* Form control dropdowns */
        .form-control select {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .form-control select:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: #4299e1;
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
        }
        
        /* Select form control improvements */
        select.form-control {
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: auto;
            min-height: 38px;
        }
        
        select.form-control option {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px 12px;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }
        
        /* Site selector dropdown fixes */
        .site-selector {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            z-index: 1040;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: auto;
            min-height: 38px;
        }
        
        .site-selector:focus {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: #4299e1;
            box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
        }
        
        /* Navigation dropdown fixes */
        .nav-tabs-custom {
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-tertiary);
            padding: 0 20px;
            position: relative;
            z-index: 1030;
            overflow: visible;
        }
        
        .nav-tabs-custom .dropdown-menu {
            top: 100%;
            margin-top: 0;
            position: absolute;
            z-index: 1050;
            min-width: 200px;
            max-height: 90vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Header positioning */
        .main-header {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--header-border);
            padding: 15px 20px;
            position: relative;
            z-index: 1040;
            overflow: visible;
        }
        
        /* Fix for table overflow issues */
        .table-responsive {
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
        }
        
        .table {
            width: 100%;
            max-width: 100%;
            margin-bottom: 0;
            table-layout: fixed;
        }
        
        .table td,
        .table th {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 12px 8px;
            vertical-align: middle;
        }
        
        .table td:last-child,
        .table th:last-child {
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }
        
        /* Fix for long text in table cells */
        .table .text-wrap {
            white-space: normal !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Card content overflow fixes */
        .card {
            overflow: visible;
        }
        
        .card-body {
            overflow: visible;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Modal fixes */
        .modal-content {
            overflow: visible;
        }
        
        .modal-body {
            overflow-y: auto;
            max-height: 70vh;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Form control fixes */
        .form-control {
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            max-width: 100%;
        }
        
        /* Button group fixes */
        .btn-group {
            overflow: visible;
            white-space: nowrap;
        }
        
        .btn-group .btn {
            float: none;
            display: inline-block;
        }
        
        /* Navbar fixes */
        .navbar-nav {
            overflow: visible;
        }
        
        .navbar-nav .nav-item {
            position: relative;
        }
        
        .navbar-nav .dropdown {
            position: static;
        }
        
        /* Container fixes */
        .container-fluid {
            overflow-x: hidden;
            overflow-y: visible;
        }
        
        /* Text truncation utilities */
        .text-truncate {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        
        .text-wrap {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        /* Flex container fixes */
        .d-flex {
            overflow: visible;
        }
        
        /* Badge overflow fixes */
        .badge {
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
            display: inline-block;
            white-space: nowrap;
        }
        
        .badge.text-wrap {
            white-space: normal !important;
            max-width: none;
        }
        
        /* Breadcrumb fixes */
        .breadcrumb {
            background: transparent;
            padding: 0;
            margin: 0;
            overflow: visible;
            flex-wrap: wrap;
        }
        
        .breadcrumb-item {
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .breadcrumb-item:last-child {
            max-width: none;
            overflow: visible;
            text-overflow: unset;
        }
        
        /* Alerts */
        .alert {
            border: none;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background-color: #2d5a3d;
            color: #68d391;
            border-left-color: #48bb78;
        }
        
        .alert-danger {
            background-color: #5a2d2d;
            color: #fc8181;
            border-left-color: #f56565;
        }
        
        .alert-warning {
            background-color: #5a4a2d;
            color: #f6ad55;
            border-left-color: #ed8936;
        }
        
        .alert-info {
            background-color: #2d4a5a;
            color: #63b3ed;
            border-left-color: #4299e1;
        }
    </style>
</head>
<body class="{% if user.is_authenticated and user_profile and user_profile.theme_preference == 'light' %}theme-light{% else %}theme-dark{% endif %}">
    {% csrf_token %}
    <!-- Main Header -->
    <div class="main-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <a href="{% url 'core:dashboard' %}" class="header-brand">
                {% if site_logo %}
                    <img src="{{ site_logo.url }}" alt="{{ site_logo.name }}" class="header-logo me-2">
                {% else %}
                    <i class="fas fa-tools me-2"></i>
                {% endif %}
                                 <span class="brand-text">{{ header_brand_text }}</span>
                 {% if site_tagline %}
                     <small class="d-block text-muted">{{ site_tagline }}</small>
                 {% endif %}
            </a>
            <span class="version-badge ml-3">
                <small class="text-muted">{{ app_version }}</small>
            </span>
        </div>
        
        <div class="header-controls">
            <!-- Site Selector -->
            <div class="d-flex align-items-center">
                <select id="site-selector" class="site-selector form-control form-control-sm" onchange="changeSite(this.value)">
                    <option value="" {% if is_all_sites %}selected{% endif %}>All - Soluna</option>
                    {% for site in sites %}
                    <option value="{{ site.id }}" {% if selected_site_id == site.id|stringformat:"s" %}selected{% endif %}>
                        {{ site.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- User Info -->
            {% if user.is_authenticated %}
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="fas fa-user me-1"></i>
                    {{ user.get_full_name|default:user.username }}
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="{% url 'core:profile' %}">
                        <i class="fas fa-user-cog me-1"></i> Profile
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="{% url 'logout' %}">
                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                    </a>
                </div>
            </div>
            {% else %}
            <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">
                <i class="fas fa-sign-in-alt me-1"></i> Login
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs-custom">
        <ul class="nav nav-tabs border-0">
            <li class="nav-item">
                                 <a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" 
                    href="{% url 'core:dashboard' %}">
                     <i class="fas fa-home me-1"></i> {{ navigation_overview_label }}
                 </a>
            </li>

            <li class="nav-item dropdown">
                                 <a class="nav-link dropdown-toggle {% if 'equipment' in request.resolver_match.url_name %}active{% endif %}" 
                    href="#" data-toggle="dropdown">
                     <i class="fas fa-cogs me-1"></i> {{ navigation_equipment_label }}
                 </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'equipment:equipment_list' %}">Equipment List</a>
                    <a class="dropdown-item" href="{% url 'equipment:add_equipment' %}">Add Equipment</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                                 <a class="nav-link dropdown-toggle {% if 'maintenance' in request.resolver_match.url_name %}active{% endif %}" 
                    href="#" data-toggle="dropdown">
                     <i class="fas fa-calendar-check me-1"></i> {{ navigation_maintenance_label }}
                 </a>
                <div class="dropdown-menu">
                    <a class="dropdown-item" href="{% url 'maintenance:maintenance_list' %}">Activities</a>
                    <a class="dropdown-item" href="{% url 'maintenance:schedule_list' %}">Schedules</a>
                    <a class="dropdown-item" href="{% url 'maintenance:schedule_override_list' %}">Schedule Overrides</a>
                </div>
            </li>
            <li class="nav-item">
                                 <a class="nav-link" href="{% url 'events:calendar_view' %}">
                     <i class="fas fa-calendar me-1"></i> {{ navigation_calendar_label }}
                 </a>
            </li>
            <li class="nav-item">
                                 <a class="nav-link" href="{% url 'core:map_view' %}">
                     <i class="fas fa-map me-1"></i> {{ navigation_map_label }}
                 </a>
            </li>
            <li class="nav-item dropdown">
                                 <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown">
                     <i class="fas fa-cog me-1"></i> {{ navigation_settings_label }}
                 </a>
                                 <div class="dropdown-menu">
                     <a class="dropdown-item" href="{% url 'core:branding_settings' %}">
                         <i class="fas fa-palette me-1"></i> Branding
                     </a>
                     <a class="dropdown-item" href="{% url 'core:settings' %}">General Settings</a>
                     <a class="dropdown-item" href="{% url 'core:locations_settings' %}">Locations</a>
                     <a class="dropdown-item" href="{% url 'core:customers_settings' %}">Customers</a>
                     <a class="dropdown-item" href="{% url 'core:equipment_items_settings' %}">Equipment Items</a>
                     <div class="dropdown-divider"></div>
                     <a class="dropdown-item" href="{% url 'core:version_html' %}">
                         <i class="fas fa-code-branch me-1"></i> Version Info
                     </a>
                     <a class="dropdown-item" href="{% url 'core:version_form' %}">
                         <i class="fas fa-edit me-1"></i> Set Version
                     </a>
                 </div>
            </li>
            {% if user.is_superuser %}
            <li class="nav-item">
                                 <a class="nav-link {% if request.resolver_match.url_name == 'debug' %}active{% endif %}" 
                    href="{% url 'core:debug' %}">
                     <i class="fas fa-bug me-1"></i> {{ navigation_debug_label }}
                 </a>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- Breadcrumb -->
    {% if request.resolver_match.url_name != 'dashboard' and request.resolver_match.url_name != 'calendar_view' %}
    <div class="container-fluid mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Home</a></li>
                {% block breadcrumb %}{% endblock %}
            </ol>
        </nav>
    </div>
    {% endif %}

    <!-- Fixed Message Container -->
    <div id="fixed-message-container" class="fixed-message-container" style="display: none;">
        <div class="container-fluid">
            <div id="message-container">
                <!-- Messages will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Legacy Messages (for backward compatibility) -->
    {% if messages %}
    <div class="container-fluid mt-3">
        <div id="legacy-message-container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show message-alert" 
                 data-message-type="{{ message.tags }}" 
                 data-message-text="{{ message|escapejs }}" 
                 role="alert">
                <i class="fas fa-info-circle me-2"></i>
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="container-fluid main-container">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                                         <p class="mb-0">{{ footer_copyright_text }}</p>
                </div>
                <div class="col-md-6 text-right">
                                         <small>{{ footer_powered_by_text }}</small>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    {% block extra_js %}{% endblock %}
    
    <script>
        // Site selector change handler
        function changeSite(siteId) {
            console.log('changeSite called with:', siteId);
            
            // First invalidate the cache to ensure fresh data
            fetch('{% url "core:invalidate_cache_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ site_id: siteId || 'all' })
            }).then(response => response.json())
            .then(data => {
                console.log('Cache invalidation result:', data);
                
                // Now navigate to the new URL
                const url = new URL(window.location);
                
                if (siteId && siteId !== '') {
                    url.searchParams.set('site_id', siteId);
                    console.log('Setting site_id to:', siteId);
                } else {
                    // Remove the site_id parameter completely for "All - Soluna"
                    url.searchParams.delete('site_id');
                    console.log('Removing site_id parameter for All Sites');
                }
                
                // Add a timestamp to force cache busting
                url.searchParams.set('_t', Date.now());
                
                console.log('Navigating to:', url.toString());
                // Force a page refresh by navigating to the new URL
                window.location.href = url.toString();
            })
            .catch(error => {
                console.error('Error invalidating cache:', error);
                // Still navigate even if cache invalidation fails
                const url = new URL(window.location);
                
                if (siteId && siteId !== '') {
                    url.searchParams.set('site_id', siteId);
                } else {
                    url.searchParams.delete('site_id');
                }
                
                url.searchParams.set('_t', Date.now());
                window.location.href = url.toString();
            });
        }
        
        // Theme switching function
        function switchTheme(theme) {
            if (theme === 'light') {
                document.body.classList.remove('theme-dark');
                document.body.classList.add('theme-light');
            } else {
                document.body.classList.remove('theme-light');
                document.body.classList.add('theme-dark');
            }
        }
        
        // Global JavaScript utilities
        $(document).ready(function() {
            // Enhanced message system
            initializeMessageSystem();
            
            // Add loading state to buttons
            $('form').on('submit', function() {
                $(this).find('button[type="submit"]').prop('disabled', true).html(
                    '<i class="fas fa-spinner fa-spin"></i> Processing...'
                );
            });
            
            // Confirm delete actions
            $('.btn-delete').on('click', function(e) {
                if (!confirm('Are you sure you want to delete this item?')) {
                    e.preventDefault();
                }
            });
        });
        
        // Enhanced Message System
        function initializeMessageSystem() {
            // Move legacy messages to fixed container
            moveMessagesToFixedContainer();
            
            // Auto-dismiss messages after 10 seconds (except error messages)
            $('.message-alert').each(function() {
                const $alert = $(this);
                const messageType = $alert.data('message-type');
                const messageText = $alert.data('message-text');
                
                // Don't auto-dismiss error messages
                if (messageType === 'error') {
                    return;
                }
                
                // Auto-dismiss after 10 seconds
                setTimeout(function() {
                    if ($alert.is(':visible')) {
                        $alert.fadeOut('slow', function() {
                            $(this).remove();
                            checkIfContainerEmpty();
                        });
                    }
                }, 10000);
            });
            
            // Handle form validation errors with field highlighting
            $('.message-alert').each(function() {
                const $alert = $(this);
                const messageText = $alert.data('message-text');
                
                // Check if this is a validation error message
                if (messageText && (
                    messageText.includes('required') || 
                    messageText.includes('invalid') || 
                    messageText.includes('error') ||
                    messageText.includes('Please enter') ||
                    messageText.includes('Please select')
                )) {
                    // Flash required fields 3 times
                    flashRequiredFields();
                }
            });
        }
        
        // Move messages to fixed container
        function moveMessagesToFixedContainer() {
            const legacyContainer = $('#legacy-message-container');
            const fixedContainer = $('#fixed-message-container .container-fluid #message-container');
            
            if (legacyContainer.length > 0 && fixedContainer.length > 0) {
                const messages = legacyContainer.find('.message-alert');
                if (messages.length > 0) {
                    // Move messages to fixed container
                    fixedContainer.append(messages);
                    
                    // Show fixed container
                    $('#fixed-message-container').show();
                    $('body').addClass('has-fixed-message');
                    
                    // Hide legacy container
                    legacyContainer.parent().hide();
                }
            }
        }
        
        // Check if message container is empty and hide if so
        function checkIfContainerEmpty() {
            const messageContainer = $('#fixed-message-container .container-fluid #message-container');
            if (messageContainer.children().length === 0) {
                $('#fixed-message-container').hide();
                $('body').removeClass('has-fixed-message');
            }
        }
        
        // Global function to show messages programmatically
        window.showMessage = function(message, type = 'info', autoDismiss = true) {
            const messageContainer = $('#fixed-message-container .container-fluid #message-container');
            const alertClass = type === 'error' ? 'alert-danger' : 
                              type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const messageHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show message-alert" 
                     data-message-type="${type}" 
                     data-message-text="${message.replace(/"/g, '&quot;')}" 
                     role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            messageContainer.append(messageHtml);
            $('#fixed-message-container').show();
            $('body').addClass('has-fixed-message');
            
            // Auto-dismiss if enabled and not an error
            if (autoDismiss && type !== 'error') {
                setTimeout(function() {
                    const $alert = messageContainer.find('.message-alert').last();
                    if ($alert.is(':visible')) {
                        $alert.fadeOut('slow', function() {
                            $(this).remove();
                            checkIfContainerEmpty();
                        });
                    }
                }, 10000);
            }
            
            // Check for validation errors and flash fields
            if (message.includes('required') || message.includes('invalid') || message.includes('error')) {
                flashRequiredFields();
            }
        };
        
        // Flash required fields function
        function flashRequiredFields() {
            // Find all required fields (inputs with required attribute or validation errors)
            const requiredFields = $('input[required], select[required], textarea[required], .is-invalid');
            
            if (requiredFields.length > 0) {
                // Flash animation - 3 times
                let flashCount = 0;
                const maxFlashes = 3;
                
                function flash() {
                    if (flashCount >= maxFlashes) return;
                    
                    requiredFields.addClass('flash-highlight');
                    
                    setTimeout(function() {
                        requiredFields.removeClass('flash-highlight');
                        flashCount++;
                        
                        if (flashCount < maxFlashes) {
                            setTimeout(flash, 300); // Wait 300ms between flashes
                        }
                    }, 200); // Flash duration
                }
                
                flash();
            }
        }
        
        // Add CSS for enhanced message system
        if (!document.getElementById('flash-styles')) {
            const style = document.createElement('style');
            style.id = 'flash-styles';
            style.textContent = `
                .fixed-message-container {
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    z-index: 9999;
                    background: rgba(0, 0, 0, 0.8);
                    backdrop-filter: blur(5px);
                    padding: 10px 0;
                    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                }
                
                .fixed-message-container .alert {
                    margin-bottom: 10px;
                    border-radius: 8px;
                    border: none;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                .fixed-message-container .alert:last-child {
                    margin-bottom: 0;
                }
                
                .flash-highlight {
                    animation: flash-animation 0.2s ease-in-out;
                    border-color: #dc3545 !important;
                    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
                }
                
                @keyframes flash-animation {
                    0% { opacity: 1; }
                    50% { opacity: 0.5; }
                    100% { opacity: 1; }
                }
                
                .message-alert {
                    transition: all 0.3s ease;
                }
                
                .message-alert.fade-out {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                
                /* Adjust body padding when fixed message is shown */
                body.has-fixed-message {
                    padding-top: 80px;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>