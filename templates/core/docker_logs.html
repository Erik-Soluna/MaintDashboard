{% extends 'base.html' %}
{% load static %}

{% block title %}Docker Logs - Settings{% endblock %}

{% block extra_css %}
<style>
    /* Dark mode styling for Docker logs viewer */
    .docker-logs-container {
        background: #1e1e1e;
        color: #ffffff;
        font-family: 'Courier New', monospace;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #333;
    }
    
    .log-line {
        margin: 2px 0;
        padding: 2px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .log-line.error {
        color: #ff6b6b;
    }
    
    .log-line.warning {
        color: #ffd93d;
    }
    
    .log-line.info {
        color: #6bcf7f;
    }
    
    .controls {
        background: #2d3748;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #4a5568;
        color: #e2e8f0;
    }
    
    .controls h5 {
        color: #e2e8f0;
    }
    
    .container-selector {
        margin-bottom: 15px;
    }
    
    .container-selector label {
        color: #e2e8f0;
        font-weight: 500;
    }
    
    .log-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .log-controls label {
        color: #e2e8f0;
        font-weight: 500;
    }
    
    .btn-refresh {
        background: #4299e1;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-refresh:hover {
        background: #3182ce;
    }
    
    .btn-follow {
        background: #48bb78;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .btn-follow:hover {
        background: #38a169;
    }
    
    .btn-follow.active {
        background: #f56565;
    }
    
    .btn-follow.active:hover {
        background: #e53e3e;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        color: #a0aec0;
    }
    
    .error-message {
        background: #742a2a;
        color: #fed7d7;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #c53030;
    }
    
    .container-info {
        background: #1a2238;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 14px;
        color: #e2e8f0;
        border: 1px solid #4a5568;
    }
    
    .container-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
        background: #1a2238;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .container-table th,
    .container-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #4a5568;
        color: #e2e8f0;
    }
    
    .container-table th {
        background: #2d3748;
        font-weight: bold;
        color: #e2e8f0;
    }
    
    .container-table tr:hover {
        background: #2d3748;
    }
    
    .container-name {
        font-weight: bold;
        color: #4299e1;
        cursor: pointer;
    }
    
    .container-name:hover {
        text-decoration: underline;
        color: #3182ce;
    }
    
    /* Dark mode form controls */
    .form-control {
        background: #1a2238;
        color: #e2e8f0;
        border: 1px solid #4a5568;
    }
    
    .form-control:focus {
        background: #1a2238;
        color: #e2e8f0;
        border-color: #4299e1;
        box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
    }
    
    /* Dark mode buttons */
    .btn-warning {
        background: #ed8936;
        border-color: #ed8936;
        color: white;
    }
    
    .btn-warning:hover {
        background: #dd6b20;
        border-color: #dd6b20;
        color: white;
    }
    
    .btn-secondary {
        background: #4a5568;
        border-color: #4a5568;
        color: #e2e8f0;
    }
    
    .btn-secondary:hover {
        background: #2d3748;
        border-color: #2d3748;
        color: #e2e8f0;
    }
    
    /* Dark mode alerts */
    .alert {
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 15px;
        border: 1px solid;
    }
    
    .alert-warning {
        background: #744210;
        color: #fbd38d;
        border-color: #d69e2e;
    }
    
    .alert-info {
        background: #2a4365;
        color: #90cdf4;
        border-color: #3182ce;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-terminal"></i> Docker Logs Viewer</h2>
                <a href="{% url 'core:settings' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Settings
                </a>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Docker Logs Viewer</strong> - View real-time logs from your Docker containers without leaving the web interface.
                This tool helps diagnose issues with your deployment stack.
            </div>
            
            <!-- Container Selection -->
            <div class="controls">
                <h5><i class="fas fa-list"></i> Available Containers</h5>
                <div id="containers-loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading containers...
                </div>
                <div id="containers-error" class="error-message" style="display: none;"></div>
                <div id="containers-list" style="display: none;">
                    <table class="container-table">
                        <thead>
                            <tr>
                                <th>Container Name</th>
                                <th>Image</th>
                                <th>Status</th>
                                <th>Ports</th>
                            </tr>
                        </thead>
                        <tbody id="containers-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Log Controls -->
            <div class="controls">
                <h5><i class="fas fa-cogs"></i> Log Controls</h5>
                <div class="container-selector">
                    <label for="container-select"><strong>Select Container:</strong></label>
                    <select id="container-select" class="form-control" style="max-width: 300px;">
                        <option value="">-- Select a container --</option>
                    </select>
                </div>
                
                <div class="log-controls">
                    <label for="lines-input"><strong>Lines:</strong></label>
                    <input type="number" id="lines-input" value="100" min="10" max="1000" class="form-control" style="width: 100px;">
                    
                    <button id="btn-refresh" class="btn-refresh">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    
                    <button id="btn-follow" class="btn-follow">
                        <i class="fas fa-play"></i> Follow
                    </button>
                    
                    <button id="btn-clear" class="btn btn-warning">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
                
                <div id="log-info" class="container-info" style="display: none;">
                    <strong>Current Container:</strong> <span id="current-container">-</span> | 
                    <strong>Lines:</strong> <span id="current-lines">-</span> | 
                    <strong>Status:</strong> <span id="follow-status">Stopped</span>
                </div>
            </div>
            
            <!-- Log Display -->
            <div class="docker-logs-container">
                <div id="logs-loading" class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading logs...
                </div>
                <div id="logs-error" class="error-message" style="display: none;"></div>
                <div id="logs-content"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let followInterval = null;
let currentContainer = '';
let isFollowing = false;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    loadContainers();
    setupEventListeners();
});

function setupEventListeners() {
    // Container selection
    document.getElementById('container-select').addEventListener('change', function() {
        currentContainer = this.value;
        if (currentContainer) {
            loadLogs();
        } else {
            clearLogs();
        }
    });
    
    // Refresh button
    document.getElementById('btn-refresh').addEventListener('click', function() {
        if (currentContainer) {
            loadLogs();
        }
    });
    
    // Follow button
    document.getElementById('btn-follow').addEventListener('click', function() {
        toggleFollow();
    });
    
    // Clear button
    document.getElementById('btn-clear').addEventListener('click', function() {
        clearLogs();
    });
    
    // Lines input
    document.getElementById('lines-input').addEventListener('change', function() {
        if (currentContainer && !isFollowing) {
            loadLogs();
        }
    });
}

function loadContainers() {
    const loadingEl = document.getElementById('containers-loading');
    const errorEl = document.getElementById('containers-error');
    const listEl = document.getElementById('containers-list');
    const tbodyEl = document.getElementById('containers-tbody');
    const selectEl = document.getElementById('container-select');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    listEl.style.display = 'none';
    
    fetch('{% url "core:get_docker_containers" %}')
        .then(response => response.json())
        .then(data => {
            loadingEl.style.display = 'none';
            
            if (data.success) {
                // Show warning if present
                if (data.warning) {
                    const warningEl = document.createElement('div');
                    warningEl.className = 'alert alert-warning';
                    warningEl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${data.warning}`;
                    listEl.parentNode.insertBefore(warningEl, listEl);
                }
                
                // Populate table
                tbodyEl.innerHTML = '';
                data.containers.forEach(container => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="container-name" onclick="selectContainer('${container.name}')">${container.name}</span></td>
                        <td>${container.image}</td>
                        <td>${container.status}</td>
                        <td>${container.ports}</td>
                    `;
                    tbodyEl.appendChild(row);
                });
                
                // Populate select dropdown
                selectEl.innerHTML = '<option value="">-- Select a container --</option>';
                data.containers.forEach(container => {
                    const option = document.createElement('option');
                    option.value = container.name;
                    option.textContent = container.name;
                    selectEl.appendChild(option);
                });
                
                listEl.style.display = 'block';
            } else {
                errorEl.textContent = data.error || 'Failed to load containers';
                errorEl.style.display = 'block';
            }
        })
        .catch(error => {
            loadingEl.style.display = 'none';
            errorEl.textContent = 'Error loading containers: ' + error.message;
            errorEl.style.display = 'block';
        });
}

function selectContainer(containerName) {
    document.getElementById('container-select').value = containerName;
    currentContainer = containerName;
    loadLogs();
}

function loadLogs() {
    if (!currentContainer) return;
    
    const lines = document.getElementById('lines-input').value;
    const loadingEl = document.getElementById('logs-loading');
    const errorEl = document.getElementById('logs-error');
    const contentEl = document.getElementById('logs-content');
    const infoEl = document.getElementById('log-info');
    
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.innerHTML = '';
    
    const url = `{% url "core:get_docker_logs" %}?container=${encodeURIComponent(currentContainer)}&lines=${lines}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            loadingEl.style.display = 'none';
            
            if (data.success) {
                displayLogs(data.logs);
                updateLogInfo(data.container, data.lines_returned);
                infoEl.style.display = 'block';
            } else {
                let errorText = data.error || 'Failed to load logs';
                if (data.suggestion) {
                    errorText += `<br><br><strong>Suggestion:</strong> ${data.suggestion}`;
                }
                errorEl.innerHTML = errorText;
                errorEl.style.display = 'block';
            }
        })
        .catch(error => {
            loadingEl.style.display = 'none';
            errorEl.textContent = 'Error loading logs: ' + error.message;
            errorEl.style.display = 'block';
        });
}

function displayLogs(logs) {
    const contentEl = document.getElementById('logs-content');
    contentEl.innerHTML = '';
    
    if (!logs || logs.trim() === '') {
        contentEl.innerHTML = '<div class="log-line">No logs available</div>';
        return;
    }
    
    const lines = logs.split('\n');
    lines.forEach(line => {
        if (line.trim()) {
            const logLine = document.createElement('div');
            logLine.className = 'log-line';
            logLine.textContent = line;
            
            // Add color coding based on log level
            if (line.toLowerCase().includes('error') || line.toLowerCase().includes('exception')) {
                logLine.classList.add('error');
            } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('warn')) {
                logLine.classList.add('warning');
            } else if (line.toLowerCase().includes('info')) {
                logLine.classList.add('info');
            }
            
            contentEl.appendChild(logLine);
        }
    });
    
    // Scroll to bottom
    contentEl.scrollTop = contentEl.scrollHeight;
}

function updateLogInfo(container, lines) {
    document.getElementById('current-container').textContent = container;
    document.getElementById('current-lines').textContent = lines;
    document.getElementById('follow-status').textContent = isFollowing ? 'Following' : 'Stopped';
}

function toggleFollow() {
    const btn = document.getElementById('btn-follow');
    
    if (isFollowing) {
        stopFollow();
    } else {
        startFollow();
    }
}

function startFollow() {
    if (!currentContainer) return;
    
    isFollowing = true;
    const btn = document.getElementById('btn-follow');
    btn.innerHTML = '<i class="fas fa-stop"></i> Stop Following';
    btn.classList.add('active');
    
    // Start polling for new logs
    followInterval = setInterval(() => {
        const lines = document.getElementById('lines-input').value;
        const url = `{% url "core:get_docker_logs" %}?container=${encodeURIComponent(currentContainer)}&lines=${lines}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogs(data.logs);
                    updateLogInfo(data.container, data.lines_returned);
                }
            })
            .catch(error => {
                console.error('Error following logs:', error);
            });
    }, 2000); // Poll every 2 seconds
}

function stopFollow() {
    isFollowing = false;
    const btn = document.getElementById('btn-follow');
    btn.innerHTML = '<i class="fas fa-play"></i> Follow';
    btn.classList.remove('active');
    
    if (followInterval) {
        clearInterval(followInterval);
        followInterval = null;
    }
}

function clearLogs() {
    document.getElementById('logs-content').innerHTML = '';
    document.getElementById('log-info').style.display = 'none';
    document.getElementById('logs-error').style.display = 'none';
    stopFollow();
}
</script>
{% endblock %} 