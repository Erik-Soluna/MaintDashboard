{% extends 'base.html' %}
{% load static %}

{% block title %}Locations Management - Maintenance Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'core:settings' %}">Settings</a></li>
<li class="breadcrumb-item active">Locations</li>
{% endblock %}

{% block extra_css %}
<style>
.locations-header {
    background-color: #2d3748;
    border-bottom: 1px solid #4a5568;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
}

.locations-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.locations-section {
    background-color: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    background-color: #1a2238;
    padding: 15px 20px;
    border-bottom: 1px solid #4a5568;
    display: flex;
    justify-content: between;
    align-items: center;
}

.section-header h5 {
    color: #e2e8f0;
    margin: 0;
    font-weight: 600;
}

.section-body {
    padding: 0;
    max-height: 400px;
    overflow-y: auto;
}

.location-item {
    padding: 15px 20px;
    border-bottom: 1px solid #4a5568;
    display: flex;
    justify-content: between;
    align-items: center;
    transition: background-color 0.2s ease;
}

.location-item:hover {
    background-color: #374151;
}

.location-item:last-child {
    border-bottom: none;
}

.location-info {
    flex: 1;
}

.location-name {
    color: #e2e8f0;
    font-weight: 600;
    margin-bottom: 4px;
}

.location-details {
    color: #a0aec0;
    font-size: 14px;
}

.location-actions {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

/* Modal Styling */
.modal-content {
    background-color: #2d3748;
    border: 1px solid #4a5568;
}

.modal-header {
    background-color: #1a2238;
    border-bottom: 1px solid #4a5568;
}

.modal-title {
    color: #e2e8f0;
}

.modal-body {
    background-color: #2d3748;
    color: #e2e8f0;
}

.modal-footer {
    background-color: #1a2238;
    border-top: 1px solid #4a5568;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    color: #e2e8f0;
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
}

.form-control, .form-select {
    background-color: #1a2238;
    color: #e2e8f0;
    border: 1px solid #4a5568;
    border-radius: 6px;
    padding: 10px 12px;
}

.form-control:focus, .form-select:focus {
    background-color: #1a2238;
    border-color: #4299e1;
    box-shadow: 0 0 0 0.2rem rgba(66, 153, 225, 0.25);
    color: #e2e8f0;
}

.form-check {
    margin-bottom: 15px;
}

.form-check-input {
    background-color: #1a2238;
    border-color: #4a5568;
}

.form-check-input:checked {
    background-color: #4299e1;
    border-color: #4299e1;
}

.form-check-label {
    color: #e2e8f0;
    margin-left: 8px;
}

.close {
    color: #e2e8f0;
    opacity: 0.8;
}

.close:hover {
    color: #e2e8f0;
    opacity: 1;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #a0aec0;
}

.empty-state i {
    font-size: 32px;
    margin-bottom: 15px;
    color: #4a5568;
}

/* Responsive design */
@media (max-width: 768px) {
    .locations-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="locations-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-0 text-white">
                <i class="fas fa-map-marker-alt me-2"></i>
                Locations Management
            </h2>
            <p class="text-muted mb-0">Manage sites and equipment locations</p>
        </div>
        <div>
            <button class="btn btn-primary me-2" data-toggle="modal" data-target="#addSiteModal">
                <i class="fas fa-plus me-1"></i>
                Add Site
            </button>
            <button class="btn btn-outline-primary" data-toggle="modal" data-target="#addLocationModal">
                <i class="fas fa-plus me-1"></i>
                Add Location
            </button>
        </div>
    </div>
</div>

<div class="locations-grid">
    <!-- Sites Column -->
    <div class="locations-section">
        <div class="section-header">
            <h5>
                <i class="fas fa-building me-2"></i>
                Sites
            </h5>
            <span class="badge badge-primary">{{ sites.count }}</span>
        </div>
        <div class="section-body">
            {% for site in sites %}
            <div class="location-item">
                <div class="location-info">
                    <div class="location-name">{{ site.name }}</div>
                    <div class="location-details">
                        {% if site.address %}{{ site.address|truncatechars:50 }}{% else %}No address specified{% endif %}
                    </div>
                </div>
                <div class="location-actions">
                    <button class="btn btn-sm btn-outline-primary edit-location-btn" 
                            data-id="{{ site.id }}" 
                            data-name="{{ site.name }}"
                            data-address="{{ site.address }}"
                            data-is-site="true"
                            data-toggle="tooltip" title="Edit Site">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-location-btn" 
                            data-id="{{ site.id }}" 
                            data-name="{{ site.name }}"
                            data-toggle="tooltip" title="Delete Site">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-building"></i>
                <p>No sites created yet</p>
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addSiteModal">
                    Add First Site
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Equipment Locations Column -->
    <div class="locations-section">
        <div class="section-header">
            <h5>
                <i class="fas fa-map-pin me-2"></i>
                Equipment Locations
            </h5>
            <span class="badge badge-primary">{{ locations.count }}</span>
        </div>
        <div class="section-body">
            {% for location in locations %}
                {% if not location.is_site %}
                <div class="location-item">
                    <div class="location-info">
                        <div class="location-name">{{ location.name }}</div>
                        <div class="location-details">
                            {% if location.parent_location %}
                                Site: {{ location.parent_location.name }}
                            {% else %}
                                No parent site
                            {% endif %}
                        </div>
                    </div>
                    <div class="location-actions">
                        <button class="btn btn-sm btn-outline-primary edit-location-btn" 
                                data-id="{{ location.id }}" 
                                data-name="{{ location.name }}"
                                data-parent="{{ location.parent_location.id|default:'' }}"
                                data-is-site="false"
                                data-toggle="tooltip" title="Edit Location">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-location-btn" 
                                data-id="{{ location.id }}" 
                                data-name="{{ location.name }}"
                                data-toggle="tooltip" title="Delete Location">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-map-pin"></i>
                <p>No equipment locations created yet</p>
                <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addLocationModal">
                    Add First Location
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Site Modal -->
<div class="modal fade" id="addSiteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Site</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addSiteForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="siteName" class="form-label">Site Name *</label>
                        <input type="text" id="siteName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="siteAddress" class="form-label">Address</label>
                        <textarea id="siteAddress" name="address" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Create Site
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Location Modal -->
<div class="modal fade" id="addLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Equipment Location</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addLocationForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="locationName" class="form-label">Location Name *</label>
                        <input type="text" id="locationName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="parentSite" class="form-label">Parent Site *</label>
                        <select id="parentSite" name="parent_location_id" class="form-control" required>
                            <option value="">Select a site</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Create Location
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Location Modal -->
<div class="modal fade" id="editLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Location</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editLocationForm">
                <div class="modal-body">
                    <input type="hidden" id="editLocationId" name="id">
                    <div class="form-group">
                        <label for="editLocationName" class="form-label">Location Name *</label>
                        <input type="text" id="editLocationName" name="name" class="form-control" required>
                    </div>
                    <div class="form-group" id="editAddressGroup">
                        <label for="editLocationAddress" class="form-label">Address</label>
                        <textarea id="editLocationAddress" name="address" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group" id="editParentGroup">
                        <label for="editParentSite" class="form-label">Parent Site *</label>
                        <select id="editParentSite" name="parent_location_id" class="form-control">
                            <option value="">Select a site</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>
                        Update Location
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLocationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteLocationName"></strong>?</p>
                <p class="text-warning">This action cannot be undone and may affect related equipment and maintenance records.</p>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="deleteLocationId">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteLocation">
                    <i class="fas fa-trash me-1"></i>
                    Delete Location
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    // Add Site Form
    $('#addSiteForm').on('submit', function(e) {
        e.preventDefault();
        const formData = {
            name: $('#siteName').val(),
            address: $('#siteAddress').val(),
            is_site: true
        };
        
        $.ajax({
            url: '{% url "core:locations_api" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            success: function(response) {
                $('#addSiteModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert('Error creating site: ' + xhr.responseJSON.message);
            }
        });
    });
    
    // Add Location Form
    $('#addLocationForm').on('submit', function(e) {
        e.preventDefault();
        const formData = {
            name: $('#locationName').val(),
            parent_location_id: $('#parentSite').val(),
            is_site: false
        };
        
        $.ajax({
            url: '{% url "core:locations_api" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            success: function(response) {
                $('#addLocationModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert('Error creating location: ' + xhr.responseJSON.message);
            }
        });
    });
    
    // Edit Location
    $('.edit-location-btn').on('click', function() {
        const id = $(this).data('id');
        const name = $(this).data('name');
        const address = $(this).data('address') || '';
        const parentId = $(this).data('parent') || '';
        const isSite = $(this).data('is-site');
        
        $('#editLocationId').val(id);
        $('#editLocationName').val(name);
        $('#editLocationAddress').val(address);
        $('#editParentSite').val(parentId);
        
        // Show/hide fields based on location type
        if (isSite) {
            $('#editAddressGroup').show();
            $('#editParentGroup').hide();
        } else {
            $('#editAddressGroup').hide();
            $('#editParentGroup').show();
        }
        
        $('#editLocationModal').modal('show');
    });
    
    // Update Location Form
    $('#editLocationForm').on('submit', function(e) {
        e.preventDefault();
        const id = $('#editLocationId').val();
        const formData = {
            name: $('#editLocationName').val(),
            address: $('#editLocationAddress').val(),
            parent_location_id: $('#editParentSite').val()
        };
        
        $.ajax({
            url: '/core/api/locations/' + id + '/',
            method: 'PUT',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json'
            },
            data: JSON.stringify(formData),
            success: function(response) {
                $('#editLocationModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert('Error updating location: ' + xhr.responseJSON.message);
            }
        });
    });
    
    // Delete Location
    $('.delete-location-btn').on('click', function() {
        const id = $(this).data('id');
        const name = $(this).data('name');
        
        $('#deleteLocationId').val(id);
        $('#deleteLocationName').text(name);
        $('#deleteLocationModal').modal('show');
    });
    
    // Confirm Delete
    $('#confirmDeleteLocation').on('click', function() {
        const id = $('#deleteLocationId').val();
        
        $.ajax({
            url: '/core/api/locations/' + id + '/',
            method: 'DELETE',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                $('#deleteLocationModal').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                alert('Error deleting location: ' + xhr.responseJSON.message);
            }
        });
    });
    
    // Reset forms when modals are hidden
    $('.modal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
    });
});
</script>
{% endblock %}