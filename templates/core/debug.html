{% extends 'base.html' %}
{% load static %}

{% block title %}Debug & Diagnostics{% endblock %}

{% block extra_css %}
<style>
.debug-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.debug-card {
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.debug-card-header {
    background: #1a202c;
    padding: 15px 20px;
    border-bottom: 1px solid #4a5568;
}

.debug-card-body {
    padding: 20px;
}

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: #1a202c;
    padding: 15px;
    border-radius: 6px;
    text-align: center;
    border: 1px solid #4a5568;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 12px;
    opacity: 0.7;
    text-transform: uppercase;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.health-indicator.healthy { background-color: var(--success-color, #48bb78); }
.health-indicator.warning { background-color: var(--warning-color, #ed8936); }
.health-indicator.error { background-color: var(--danger-color, #f56565); }

.data-table {
    width: 100%;
    font-size: 13px;
}

.data-table th {
    background: #1a202c;
    padding: 10px;
    text-align: left;
    border-bottom: 2px solid #4a5568;
}

.data-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #4a5568;
}

.code-block {
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
}

.action-btn {
    margin-right: 10px;
    margin-bottom: 10px;
}

.log-entry {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 4px solid #4a5568;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0 4px 4px 0;
    font-size: 13px;
}

.log-entry.error { border-left-color: var(--danger-color, #f56565); }
.log-entry.warning { border-left-color: var(--warning-color, #ed8936); }
.log-entry.info { border-left-color: var(--info-color, #4299e1); }
.log-entry.success { border-left-color: var(--success-color, #48bb78); }
</style>
{% endblock %}

{% block content %}
<div class="debug-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-bug me-2"></i>Debug & Diagnostics
        </h2>
        <button class="btn btn-primary" onclick="refreshAll()">
            <i class="fas fa-sync-alt me-1"></i>Refresh All
        </button>
    </div>

    <!-- Quick Stats -->
    <div class="debug-card">
        <div class="debug-card-header">
            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>System Overview</h5>
        </div>
        <div class="debug-card-body">
            <div class="stat-grid" id="system-stats">
                <div class="stat-card">
                    <div class="stat-value text-muted"><i class="fas fa-spinner fa-spin"></i></div>
                    <div class="stat-label">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Status -->
    <div class="debug-card">
        <div class="debug-card-header">
            <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i>System Health</h5>
        </div>
        <div class="debug-card-body">
            <div id="health-status">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>Loading health status...
                </div>
            </div>
        </div>
    </div>

    <!-- Database Information -->
    <div class="debug-card">
        <div class="debug-card-header">
            <h5 class="mb-0"><i class="fas fa-database me-2"></i>Database Statistics</h5>
        </div>
        <div class="debug-card-body">
            <div id="database-stats">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>Loading database statistics...
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Logs & Errors -->
    <div class="debug-card">
        <div class="debug-card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Recent Logs & Errors</h5>
            <button class="btn btn-sm btn-outline-danger" onclick="clearLogs()">
                <i class="fas fa-trash me-1"></i>Clear Logs
            </button>
        </div>
        <div class="debug-card-body">
            <div id="recent-logs">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>Loading recent logs...
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="debug-card">
        <div class="debug-card-header">
            <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
        </div>
        <div class="debug-card-body">
            <h6 class="mb-3">Cache Management</h6>
            <div class="mb-4">
                <button class="btn btn-primary action-btn" onclick="clearCache()">
                    <i class="fas fa-broom me-1"></i>Clear Cache
                </button>
                <button class="btn btn-info action-btn" onclick="getCacheStats()">
                    <i class="fas fa-chart-bar me-1"></i>Cache Stats
                </button>
            </div>

            <h6 class="mb-3">Database Management</h6>
            <div class="mb-4">
                <button class="btn btn-success action-btn" onclick="showDemoDataModal()">
                    <i class="fas fa-database me-1"></i>Generate Demo Data
                </button>
                <button class="btn btn-warning action-btn" onclick="checkMigrationStatus()">
                    <i class="fas fa-code-branch me-1"></i>Migration Status
                </button>
                <button class="btn btn-danger action-btn" onclick="showClearDatabaseModal()">
                    <i class="fas fa-trash-alt me-1"></i>Clear Database
                </button>
            </div>

            <h6 class="mb-3">System Operations</h6>
            <div>
                <button class="btn btn-primary action-btn" onclick="runHealthCheck()">
                    <i class="fas fa-stethoscope me-1"></i>Run Health Check
                </button>
                <button class="btn btn-info action-btn" onclick="checkConnections()">
                    <i class="fas fa-network-wired me-1"></i>Test Connections
                </button>
                <button class="btn btn-success action-btn" onclick="viewSystemInfo()">
                    <i class="fas fa-info-circle me-1"></i>System Info
                </button>
            </div>
        </div>
    </div>

    <!-- Action Results -->
    <div class="debug-card" id="results-card" style="display: none;">
        <div class="debug-card-header">
            <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Operation Results</h5>
        </div>
        <div class="debug-card-body">
            <div id="action-results" class="code-block"></div>
        </div>
    </div>
</div>

<!-- Demo Data Modal -->
<div class="modal fade" id="demoDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-database me-2"></i>Generate Demo Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This will generate sample customers, locations, equipment, and maintenance activities for testing.
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="clear-first" checked>
                    <label class="form-check-label" for="clear-first">Clear existing data first</label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateDemoData()">
                    <i class="fas fa-play me-1"></i>Generate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clear Database Modal -->
<div class="modal fade" id="clearDatabaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Clear Database
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <strong>WARNING:</strong> This will delete all data. This action cannot be undone.
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Type "CLEAR DATABASE" to confirm:</label>
                    <input type="text" id="clear-confirmation" class="form-control" placeholder="CLEAR DATABASE">
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="keep-users">
                    <label class="form-check-label" for="keep-users">Keep user accounts</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dry-run" checked>
                    <label class="form-check-label" for="dry-run">Dry run (preview only)</label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-clear" disabled onclick="clearDatabase()">
                    <i class="fas fa-trash-alt me-1"></i>Clear Database
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Info Modal -->
<div class="modal fade" id="systemInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>System Information</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="system-info-content" class="code-block" style="max-height: 500px;">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-1"></i>Loading system information...
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSystemStats();
    loadHealthStatus();
    loadDatabaseStats();
    loadRecentLogs();
    
    // Setup confirmation input
    const clearConfirmInput = document.getElementById('clear-confirmation');
    if (clearConfirmInput) {
        clearConfirmInput.addEventListener('input', function() {
            document.getElementById('confirm-clear').disabled = this.value !== 'CLEAR DATABASE';
        });
    }
});

function refreshAll() {
    if (window.showMessage) {
        window.showMessage('Refreshing all debug information...', 'info');
    }
    loadSystemStats();
    loadHealthStatus();
    loadDatabaseStats();
    loadRecentLogs();
}

function loadSystemStats() {
    fetch('{% url "core:comprehensive_health_check" %}')
        .then(response => response.json())
        .then(data => {
            const system = data.components?.system || {};
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-value text-${system.cpu_percent > 80 ? 'danger' : 'success'}">
                        ${system.cpu_percent ? system.cpu_percent.toFixed(1) + '%' : 'N/A'}
                    </div>
                    <div class="stat-label">CPU Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-${system.memory_percent > 80 ? 'danger' : 'warning'}">
                        ${system.memory_percent ? system.memory_percent.toFixed(1) + '%' : 'N/A'}
                    </div>
                    <div class="stat-label">Memory Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-${system.disk_usage > 90 ? 'danger' : 'info'}">
                        ${system.disk_usage ? system.disk_usage.toFixed(1) + '%' : 'N/A'}
                    </div>
                    <div class="stat-label">Disk Usage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-success">
                        ${system.process_count || 'N/A'}
                    </div>
                    <div class="stat-label">Processes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value text-${data.overall_status === 'healthy' ? 'success' : 'danger'}">
                        ${data.overall_status || 'Unknown'}
                    </div>
                    <div class="stat-label">Overall Status</div>
                </div>
            `;
            document.getElementById('system-stats').innerHTML = statsHtml;
        })
        .catch(error => {
            document.getElementById('system-stats').innerHTML = '<div class="text-danger">Failed to load system stats</div>';
        });
}

function loadHealthStatus() {
    fetch('{% url "core:health_check_api" %}')
        .then(response => response.json())
        .then(data => {
            let html = '<table class="data-table"><thead><tr><th>Component</th><th>Status</th><th>Details</th></tr></thead><tbody>';
            
            if (data.checks && Array.isArray(data.checks)) {
                data.checks.forEach(check => {
                    const statusClass = check.status === 'success' ? 'success' : check.status === 'error' ? 'danger' : 'warning';
                    const indicatorClass = check.status === 'success' ? 'healthy' : check.status === 'error' ? 'error' : 'warning';
                    html += `
                        <tr>
                            <td><span class="health-indicator ${indicatorClass}"></span>${check.name}</td>
                            <td><span class="badge bg-${statusClass}">${check.status}</span></td>
                            <td><small>${check.message || '-'}</small></td>
                        </tr>
                    `;
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('health-status').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('health-status').innerHTML = '<div class="text-danger">Failed to load health status</div>';
        });
}

function loadDatabaseStats() {
    // Call a new endpoint to get database statistics
    const statsHtml = `
        <table class="data-table">
            <thead>
                <tr><th>Table</th><th>Row Count</th><th>Size</th></tr>
            </thead>
            <tbody id="db-table-stats">
                <tr><td colspan="3" class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>Loading database statistics...
                </td></tr>
            </tbody>
        </table>
    `;
    document.getElementById('database-stats').innerHTML = statsHtml;
    
    // Fetch actual stats
    fetch('/core/api/database-stats/')
        .then(response => response.json())
        .then(data => {
            if (data.tables) {
                let html = '';
                Object.entries(data.tables).forEach(([table, info]) => {
                    html += `
                        <tr>
                            <td><code>${table}</code></td>
                            <td>${info.count || 'N/A'}</td>
                            <td><small class="text-muted">${info.size || 'N/A'}</small></td>
                        </tr>
                    `;
                });
                document.getElementById('db-table-stats').innerHTML = html;
            }
        })
        .catch(error => {
            document.getElementById('db-table-stats').innerHTML = '<tr><td colspan="3" class="text-danger">Failed to load database statistics</td></tr>';
        });
}

function loadRecentLogs() {
    const logsHtml = `
        <div class="log-entry info">
            <strong>System Started</strong><br>
            <small>Application is running in DEBUG mode</small>
        </div>
        <div class="log-entry success">
            <strong>Database Connected</strong><br>
            <small>PostgreSQL connection established</small>
        </div>
    `;
    document.getElementById('recent-logs').innerHTML = logsHtml;
    
    // Load actual logs from health check
    fetch('{% url "core:health_check" %}')
        .then(response => response.json())
        .then(data => {
            if (data.checks) {
                let html = '';
                data.checks.forEach(check => {
                    if (check.status === 'error' || check.status === 'warning') {
                        const logClass = check.status === 'error' ? 'error' : 'warning';
                        html += `
                            <div class="log-entry ${logClass}">
                                <strong>${check.name}</strong><br>
                                <small>${check.message}</small>
                            </div>
                        `;
                    }
                });
                if (html) {
                    document.getElementById('recent-logs').innerHTML = html;
                } else {
                    document.getElementById('recent-logs').innerHTML = '<div class="text-muted">No recent errors or warnings</div>';
                }
            }
        })
        .catch(error => {
            console.error('Error loading logs:', error);
        });
}

function clearCache() {
    if (!confirm('Clear all cache data?')) return;
    
    fetch('{% url "core:invalidate_cache_api" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (window.showMessage) {
            window.showMessage(data.message || 'Cache cleared successfully', 'success');
        }
        showResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        if (window.showMessage) {
            window.showMessage('Error clearing cache: ' + error.message, 'error');
        }
    });
}

function getCacheStats() {
    showResult('Cache statistics feature coming soon...');
}

function checkMigrationStatus() {
    showResult('Checking migration status...');
    // This would call a management command
    if (window.showMessage) {
        window.showMessage('Checking migration status...', 'info');
    }
}

function runHealthCheck() {
    fetch('{% url "core:run_health_check" %}')
        .then(response => response.json())
        .then(data => {
            showResult(JSON.stringify(data, null, 2));
            if (window.showMessage) {
                window.showMessage('Health check completed', 'success');
            }
            loadHealthStatus();
        })
        .catch(error => {
            if (window.showMessage) {
                window.showMessage('Error running health check: ' + error.message, 'error');
            }
        });
}

function checkConnections() {
    showResult('Testing database, cache, and external connections...');
    loadHealthStatus();
}

function viewSystemInfo() {
    const modal = new bootstrap.Modal(document.getElementById('systemInfoModal'));
    modal.show();
    
    fetch('{% url "core:version_html" %}')
        .then(response => response.text())
        .then(html => {
            // Extract just the version info from the response
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const content = doc.querySelector('.container') || doc.body;
            document.getElementById('system-info-content').innerHTML = content.innerHTML;
        })
        .catch(error => {
            document.getElementById('system-info-content').innerHTML = 
                '<div class="text-danger">Error loading system info: ' + error.message + '</div>';
        });
}

function showDemoDataModal() {
    const modal = new bootstrap.Modal(document.getElementById('demoDataModal'));
    modal.show();
}

function generateDemoData() {
    const clearFirst = document.getElementById('clear-first').checked;
    
    if (window.showMessage) {
        window.showMessage('Generating demo data...', 'info');
    }
    
    const formData = new FormData();
    formData.append('clear_first', clearFirst);
    formData.append('include_maintenance', true);
    formData.append('include_events', true);
    
    fetch('{% url "core:populate_demo_data" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.showMessage) {
                window.showMessage(`Demo data generated! Created ${data.created_count} items`, 'success');
            }
            bootstrap.Modal.getInstance(document.getElementById('demoDataModal')).hide();
            setTimeout(refreshAll, 1000);
        } else {
            if (window.showMessage) {
                window.showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
            }
        }
    })
    .catch(error => {
        if (window.showMessage) {
            window.showMessage('Error generating demo data: ' + error.message, 'error');
        }
    });
}

function showClearDatabaseModal() {
    const modal = new bootstrap.Modal(document.getElementById('clearDatabaseModal'));
    modal.show();
    document.getElementById('clear-confirmation').value = '';
    document.getElementById('confirm-clear').disabled = true;
}

function clearDatabase() {
    const keepUsers = document.getElementById('keep-users').checked;
    const dryRun = document.getElementById('dry-run').checked;
    
    if (window.showMessage) {
        window.showMessage(dryRun ? 'Running dry run...' : 'Clearing database...', 'warning');
    }
    
    const formData = new FormData();
    formData.append('keep_users', keepUsers);
    formData.append('dry_run', dryRun);
    
    fetch('{% url "core:clear_database" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showResult(data.output || data.message);
        if (data.success) {
            if (window.showMessage) {
                window.showMessage(dryRun ? 'Dry run completed' : 'Database cleared successfully', 'success');
            }
            bootstrap.Modal.getInstance(document.getElementById('clearDatabaseModal')).hide();
            if (!dryRun) {
                setTimeout(() => window.location.reload(), 2000);
            }
        } else {
            if (window.showMessage) {
                window.showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
            }
        }
    })
    .catch(error => {
        if (window.showMessage) {
            window.showMessage('Error: ' + error.message, 'error');
        }
    });
}

function clearLogs() {
    if (!confirm('Clear all health failure logs?')) return;
    
    fetch('{% url "core:clear_health_logs" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.showMessage) {
                window.showMessage('Logs cleared successfully', 'success');
            }
            loadRecentLogs();
        }
    })
    .catch(error => {
        if (window.showMessage) {
            window.showMessage('Error clearing logs: ' + error.message, 'error');
        }
    });
}

function showResult(result) {
    const card = document.getElementById('results-card');
    const resultsDiv = document.getElementById('action-results');
    
    card.style.display = 'block';
    resultsDiv.textContent = result;
    
    // Scroll to results
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
</script>
{% endblock %}
