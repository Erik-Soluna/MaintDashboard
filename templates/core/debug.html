{% extends 'base.html' %}
{% load static %}

{% block title %}Debug & Diagnostics{% endblock %}

{% block extra_css %}
<style>
/* Debug page specific styles */
.debug-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.debug-section {
    background: var(--bs-dark);
    border: 1px solid var(--bs-secondary);
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.debug-header {
    background: var(--bs-secondary);
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: between;
    align-items: center;
    transition: background-color 0.3s ease;
}

.debug-header:hover {
    background: var(--bs-secondary-dark);
}

.debug-header h5 {
    margin: 0;
    color: var(--bs-light);
    display: flex;
    align-items: center;
}

.debug-header .collapse-icon {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.debug-header.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.debug-body {
    padding: 20px;
    display: block;
}

.debug-body.collapsed {
    display: none;
}

/* Health Status Summary */
.health-status {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 10px;
}

.health-indicator.healthy { background-color: #28a745; }
.health-indicator.warning { background-color: #ffc107; }
.health-indicator.error { background-color: #dc3545; }

/* Diagnostic buttons */
.diagnostic-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.diagnostic-button {
    padding: 8px 16px;
    border: 1px solid var(--bs-secondary);
    background: var(--bs-dark);
    color: var(--bs-light);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    font-size: 14px;
}

.diagnostic-button:hover {
    background: var(--bs-secondary);
    color: var(--bs-light);
    text-decoration: none;
}

.diagnostic-button.primary {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
}

.diagnostic-button.primary:hover {
    background: var(--bs-primary-dark);
}

.diagnostic-button.warning {
    background: var(--bs-warning);
    border-color: var(--bs-warning);
    color: var(--bs-dark);
}

.diagnostic-button.warning:hover {
    background: var(--bs-warning-dark);
}

/* Playwright form */
.playwright-form {
    margin-bottom: 20px;
}

.playwright-form .form-group {
    margin-bottom: 15px;
}

.playwright-form textarea {
    background: var(--bs-dark);
    border: 1px solid var(--bs-secondary);
    color: var(--bs-light);
}

.playwright-form textarea:focus {
    background: var(--bs-dark);
    border-color: var(--bs-primary);
    color: var(--bs-light);
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* Output areas */
.playwright-output, .diagnostic-output {
    background: var(--bs-darker);
    border: 1px solid var(--bs-secondary);
    border-radius: 4px;
    padding: 15px;
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 13px;
}

.log-entry {
    padding: 8px 12px;
    margin-bottom: 8px;
    border-left: 4px solid var(--bs-secondary);
    background: rgba(255, 255, 255, 0.05);
    border-radius: 0 4px 4px 0;
}

.log-entry.pending { border-left-color: #ffc107; }
.log-entry.running { border-left-color: #4299e1; }
.log-entry.done { border-left-color: #28a745; }
.log-entry.error { border-left-color: #dc3545; }

/* Info text */
.info-text {
    color: var(--bs-secondary);
    font-size: 13px;
    margin-top: 5px;
}

/* Responsive */
@media (max-width: 768px) {
    .diagnostic-buttons {
        flex-direction: column;
    }
    
    .diagnostic-button {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="debug-container">
    <div class="page-header mb-4">
        <h2 class="mb-0">
            <i class="fas fa-bug me-2"></i>
            Debug & Diagnostics
        </h2>
        <p class="text-muted mb-0">System monitoring, testing, and debugging tools</p>
    </div>

    <!-- System Health Section -->
    <div class="debug-section">
        <div class="debug-header" onclick="toggleSection('health')">
            <h5>
                <i class="fas fa-heartbeat me-2"></i>
                System Health
            </h5>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="debug-body" id="health-body">
            {% if health %}
                <div class="health-status">
                    <span class="health-indicator {% if health.status == 'ok' %}healthy{% elif health.status == 'warning' %}warning{% else %}error{% endif %}"></span>
                    <span>System status: <b>{{ health.status|title }}</b></span>
                </div>
                <ul class="list-group mb-3">
                    {% for check in health.checks %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><b>{{ check.name }}</b>: {{ check.message }}</span>
                        <span class="badge {% if check.status == 'ok' %}bg-success{% elif check.status == 'warning' %}bg-warning text-dark{% else %}bg-danger{% endif %}">{{ check.status|title }}</span>
                    </li>
                    {% endfor %}
                </ul>
                <h6>Recent Health Failures
                    <button id="clear-health-logs" class="btn btn-sm btn-outline-danger ms-2" type="button">
                        <i class="fas fa-trash-alt me-1"></i>Clear Logs
                    </button>
                </h6>
                <ul class="list-group" id="health-failure-log-list" style="max-height: 300px; overflow-y: auto;">
                    {% for log in health.last_failure_log %}
                    <li class="list-group-item small">
                        <b>{{ log.timestamp }}</b> | <b>{{ log.component }}</b>: {{ log.message }}
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No recent failures.</li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-secondary">Health status unavailable.</div>
            {% endif %}
        </div>
    </div>

    <!-- System Tools & Diagnostics Section -->
    {% if user.is_superuser %}
    <div class="debug-section">
        <div class="debug-header" onclick="toggleSection('tools')">
            <h5>
                <i class="fas fa-tools me-2"></i>
                System Tools & Diagnostics
            </h5>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="debug-body" id="tools-body">
            <!-- Health & Diagnostics Tools -->
            <div class="mb-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-stethoscope me-2"></i>Health & Diagnostics
                </h6>
                <div class="diagnostic-buttons">
                    <button class="diagnostic-button primary" onclick="testApplicationHealth()">
                        <i class="fas fa-vial me-1"></i>Test All Components
                    </button>
                    <button class="diagnostic-button" onclick="testUnifiedAPI()">
                        <i class="fas fa-calendar-alt me-1"></i>Test Calendar API
                    </button>
                    <button class="diagnostic-button" onclick="testDatabaseHealth()">
                        <i class="fas fa-database me-1"></i>Test Database
                    </button>
                    <button class="diagnostic-button" onclick="testCacheHealth()">
                        <i class="fas fa-memory me-1"></i>Test Cache
                    </button>
                    <button class="diagnostic-button warning" onclick="runHealthCheck()">
                        <i class="fas fa-heartbeat me-1"></i>Run Health Check
                    </button>
                    <a href="{% url 'events:test_events_api' %}" target="_blank" class="diagnostic-button">
                        <i class="fas fa-external-link-alt me-1"></i>Test Events API
                    </a>
                </div>
            </div>
            
            <!-- Database Management Tools -->
            <div class="mb-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-database me-2"></i>Database Management
                </h6>
                <div class="diagnostic-buttons">
                    <button class="diagnostic-button" onclick="showDatabaseClearModal()">
                        <i class="fas fa-trash-alt me-1"></i>Clear Database
                    </button>
                    <button class="diagnostic-button" onclick="showDatabaseStats()">
                        <i class="fas fa-chart-bar me-1"></i>Database Stats
                    </button>
                    <button class="diagnostic-button" onclick="backupDatabase()">
                        <i class="fas fa-download me-1"></i>Backup Database
                    </button>
                    <button class="diagnostic-button primary" onclick="showDemoDataModal()">
                        <i class="fas fa-database me-1"></i>Populate Demo Data
                    </button>
                </div>
            </div>
            
            <!-- Development Tools -->
            <div class="mb-4">
                <h6 class="text-light mb-3">
                    <i class="fas fa-code me-2"></i>Development Tools
                </h6>
                <div class="diagnostic-buttons">
                    <button class="diagnostic-button" onclick="generatePods()">
                        <i class="fas fa-sitemap me-1"></i>Generate PODs
                    </button>
                    <button class="diagnostic-button" onclick="populateSampleData()">
                        <i class="fas fa-seedling me-1"></i>Populate Sample Data
                    </button>
                    <button class="diagnostic-button" onclick="resetRBAC()">
                        <i class="fas fa-users-cog me-1"></i>Reset RBAC
                    </button>
                </div>
            </div>
            
            <div id="diagnosticResults" class="diagnostic-output" style="display: none;">
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Click a diagnostic button above to see results...
                </div>
            </div>
        </div>
    </div>

    <!-- Playwright Debug Section -->
    <div class="debug-section">
        <div class="debug-header" onclick="toggleSection('playwright')">
            <h5>
                <i class="fas fa-bug me-2"></i>
                Playwright Debug & Testing
            </h5>
            <i class="fas fa-chevron-down collapse-icon"></i>
        </div>
        <div class="debug-body" id="playwright-body">
            <div class="playwright-form">
                <div class="form-group">
                    <label for="playwright-prompt" class="form-label">Natural Language Prompt</label>
                    <textarea id="playwright-prompt" class="form-control" rows="3" 
                              placeholder="Examples:&#10;- Add a Site called Sophie with 11 Pods and 2 MDCs per Pod&#10;- Create equipment called Transformer-1 in Site Alpha&#10;- Test the login page&#10;- Check the dashboard"></textarea>
                    <div class="info-text">Describe what you want Playwright to do in natural language. The system will automatically interpret your request and perform the appropriate actions.</div>
                </div>
                <button class="diagnostic-button primary" onclick="submitPlaywrightPrompt()">
                    <i class="fas fa-play me-1"></i>Run Playwright Test
                </button>
                <button class="diagnostic-button" onclick="refreshPlaywrightLogs()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh Logs
                </button>
            </div>
            
            <div id="playwrightLogs" class="playwright-output">
                <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    Loading Playwright logs...
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Demo Data Population Modal -->
<div class="modal fade" id="demoDataModal" tabindex="-1" aria-labelledby="demoDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="demoDataModalLabel">
                    <i class="fas fa-database text-primary me-2"></i>
                    Populate Comprehensive Demo Data
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This will populate the database with comprehensive demo data including sites, equipment, maintenance activities, and more.
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="clearFirst" checked>
                    <label class="form-check-label" for="clearFirst">
                        Clear existing data first
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeMaintenance" checked>
                    <label class="form-check-label" for="includeMaintenance">
                        Include maintenance activities
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeEvents" checked>
                    <label class="form-check-label" for="includeEvents">
                        Include calendar events
                    </label>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="populateDemoData()">
                    <i class="fas fa-database me-1"></i>Populate Demo Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Database Clear Confirmation Modal -->
<div class="modal fade" id="databaseClearModal" tabindex="-1" aria-labelledby="databaseClearModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="databaseClearModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Clear Database
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will permanently delete all data in the database. This action cannot be undone.
                </div>
                <p>Are you sure you want to clear all data from the database?</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearDatabase()">
                    <i class="fas fa-trash-alt me-1"></i>Clear Database
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Section toggle functionality
function toggleSection(sectionId) {
    const header = document.querySelector(`#${sectionId}-body`).previousElementSibling;
    const body = document.getElementById(`${sectionId}-body`);
    
    if (body.classList.contains('collapsed')) {
        body.classList.remove('collapsed');
        header.classList.remove('collapsed');
    } else {
        body.classList.add('collapsed');
        header.classList.add('collapsed');
    }
}

// Initialize sections (all expanded by default)
document.addEventListener('DOMContentLoaded', function() {
    // Load Playwright logs on page load
    refreshPlaywrightLogs();
    
    // Initialize health logs clear functionality
    document.getElementById('clear-health-logs')?.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all health logs?')) {
            fetch('{% url "core:clear_health_logs" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Failed to clear logs: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to clear logs');
            });
        }
    });
});

// Playwright Debug Functions
function submitPlaywrightPrompt() {
    const prompt = document.getElementById('playwright-prompt').value.trim();
    if (!prompt) {
        alert('Please enter a prompt');
        return;
    }

    const logsContainer = document.getElementById('playwrightLogs');
    logsContainer.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Running Playwright test...</div>';

    fetch('{% url "core:playwright_debug_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({ prompt: prompt })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            logsContainer.innerHTML = `<div class="log-entry done"><strong>Test submitted:</strong> ${prompt}<br><small>Log ID: ${data.log_id}</small></div>`;
            // Refresh logs after a short delay
            setTimeout(refreshPlaywrightLogs, 2000);
        } else {
            logsContainer.innerHTML = `<div class="log-entry error"><strong>Error:</strong> ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        logsContainer.innerHTML = '<div class="log-entry error"><strong>Error:</strong> Failed to submit test</div>';
    });
}

function refreshPlaywrightLogs() {
    const logsContainer = document.getElementById('playwrightLogs');
    
    fetch('{% url "core:playwright_debug_api" %}')
    .then(response => response.json())
    .then(data => {
        let html = '<h6 class="mb-3">Recent Playwright Debug Logs</h6>';
        
        if (data.logs && data.logs.length > 0) {
            data.logs.forEach(log => {
                const statusClass = log.status === 'done' ? 'done' : 
                                  log.status === 'running' ? 'running' : 
                                  log.status === 'error' ? 'error' : 'pending';
                
                html += `
                    <div class="log-entry ${statusClass}">
                        <strong>${log.created_at}</strong> - ${log.prompt}<br>
                        <small>Status: ${log.status} | ID: ${log.id}</small>
                        ${log.result ? `<br><pre class="mt-2">${log.result}</pre>` : ''}
                    </div>
                `;
            });
        } else {
            html += '<div class="text-muted">No logs found</div>';
        }
        
        logsContainer.innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        logsContainer.innerHTML = '<div class="log-entry error"><strong>Error:</strong> Failed to load logs</div>';
    });
}

// Diagnostic Functions
function testApplicationHealth() {
    showDiagnosticResult('Testing application health...');
    fetch('{% url "core:test_health" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function testUnifiedAPI() {
    showDiagnosticResult('Testing unified API...');
    fetch('{% url "core:test_unified_api" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function testDatabaseHealth() {
    showDiagnosticResult('Testing database health...');
    fetch('{% url "core:test_database" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function testCacheHealth() {
    showDiagnosticResult('Testing cache health...');
    fetch('{% url "core:test_cache" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function runHealthCheck() {
    showDiagnosticResult('Running health check...');
    fetch('{% url "core:run_health_check" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function showDatabaseClearModal() {
    new bootstrap.Modal(document.getElementById('databaseClearModal')).show();
}

function clearDatabase() {
    showDiagnosticResult('Clearing database...');
    fetch('{% url "core:clear_database" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
        if (data.success) {
            setTimeout(() => location.reload(), 2000);
        }
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function showDatabaseStats() {
    showDiagnosticResult('Loading database stats...');
    fetch('{% url "core:database_stats" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function backupDatabase() {
    showDiagnosticResult('Creating database backup...');
    fetch('{% url "core:backup_database" %}')
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function showDemoDataModal() {
    new bootstrap.Modal(document.getElementById('demoDataModal')).show();
}

function populateDemoData() {
    const clearFirst = document.getElementById('clearFirst').checked;
    const includeMaintenance = document.getElementById('includeMaintenance').checked;
    const includeEvents = document.getElementById('includeEvents').checked;
    
    showDiagnosticResult('Populating demo data...');
    
    fetch('{% url "core:populate_demo_data" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            clear_first: clearFirst,
            include_maintenance: includeMaintenance,
            include_events: includeEvents
        })
    })
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
        if (data.success) {
            setTimeout(() => location.reload(), 2000);
        }
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function generatePods() {
    showDiagnosticResult('Generating PODs...');
    fetch('{% url "core:generate_pods" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function populateSampleData() {
    showDiagnosticResult('Populating sample data...');
    fetch('{% url "core:populate_sample_data" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function resetRBAC() {
    showDiagnosticResult('Resetting RBAC...');
    fetch('{% url "core:reset_rbac" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
    })
    .then(response => response.json())
    .then(data => {
        showDiagnosticResult(JSON.stringify(data, null, 2));
    })
    .catch(error => {
        showDiagnosticResult('Error: ' + error.message);
    });
}

function showDiagnosticResult(result) {
    const resultsDiv = document.getElementById('diagnosticResults');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = `<pre>${result}</pre>`;
    resultsDiv.scrollTop = resultsDiv.scrollHeight;
}
</script>
{% endblock %} 