{% extends 'base.html' %}
{% load static %}

{% block title %}Map - Equipment Dependency Diagram{% endblock %}

{% block extra_css %}
<style>
.map-container {
    background-color: #1a2238;
    min-height: 100vh;
    color: white;
    padding: 20px;
}

.map-header {
    background-color: #0f1419;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-bottom: 1px solid #2d3748;
}

#map-canvas {
    position: relative;
    width: 100%;
    min-height: 600px;
    background-color: #2d3748;
    border-radius: 8px;
    overflow: auto;
}

#map-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1;
}

.equipment-node {
    position: absolute;
    background-color: var(--success-color, #48bb78);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: move;
    transition: all 0.3s ease;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    min-width: 150px;
    text-align: center;
}

.equipment-node:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    z-index: 3;
}

.equipment-node.status-active {
    background-color: var(--success-color, #48bb78);
    border: 2px solid #2f855a;
}

.equipment-node.status-inactive {
    background-color: #718096;
    border: 2px solid #4a5568;
}

.equipment-node.status-maintenance {
    background-color: var(--warning-color, #ed8936);
    border: 2px solid #c05621;
}

.equipment-node.status-retired {
    background-color: #4a5568;
    border: 2px solid #2d3748;
}

.equipment-node.status-cascade-offline {
    background-color: var(--danger-color, #f56565);
    border: 2px solid #c53030;
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.equipment-node-name {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 4px;
}

.equipment-node-location {
    font-size: 11px;
    opacity: 0.8;
}

.equipment-node-status {
    font-size: 10px;
    margin-top: 4px;
    padding: 2px 6px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.connection-line {
    stroke-width: 2;
    fill: none;
    pointer-events: none;
}

.connection-line.critical {
    stroke: var(--danger-color, #f56565);
    stroke-width: 3;
}

.connection-line.non-critical {
    stroke: var(--info-color, #4299e1);
    stroke-width: 2;
    stroke-dasharray: 5,5;
}

.connection-arrow {
    fill: var(--info-color, #4299e1);
}

.connection-arrow.critical {
    fill: var(--danger-color, #f56565);
}

.legend {
    background-color: #0f1419;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.legend-item {
    display: inline-flex;
    align-items: center;
    margin-right: 20px;
    margin-bottom: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 8px;
}

.legend-line {
    width: 40px;
    height: 3px;
    margin-right: 8px;
}

.legend-line.dashed {
    background: repeating-linear-gradient(
        to right,
        var(--info-color, #4299e1) 0,
        var(--info-color, #4299e1) 5px,
        transparent 5px,
        transparent 10px
    );
}

.map-controls {
    background-color: #0f1419;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.map-controls .btn {
    margin-right: 10px;
    margin-bottom: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="map-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-project-diagram me-2"></i>
                    Equipment Dependency Map
                </h2>
                <p class="mb-0 text-light">Interactive view of equipment connections and dependencies</p>
            </div>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="autoLayout()">
                    <i class="fas fa-magic"></i> Auto Layout
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="resetPositions()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
        </div>
    </div>

    <div class="legend">
        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Legend</h5>
        <div class="row">
            <div class="col-md-6">
                <strong>Equipment Status:</strong>
                <div class="mt-2">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--success-color, #48bb78);"></div>
                        <span>Active</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--warning-color, #ed8936);"></div>
                        <span>Under Maintenance</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #718096;"></div>
                        <span>Inactive</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--danger-color, #f56565);"></div>
                        <span>Cascade Offline (Upstream Failure)</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <strong>Connection Types:</strong>
                <div class="mt-2">
                    <div class="legend-item">
                        <div class="legend-line" style="background-color: var(--danger-color, #f56565); height: 3px;"></div>
                        <span>Critical Connection (Solid)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line dashed"></div>
                        <span>Non-Critical Connection (Dashed)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="map-controls">
        <strong><i class="fas fa-tools me-2"></i>Tools:</strong>
        <button class="btn btn-sm btn-primary" onclick="showConnectionManager()">
            <i class="fas fa-link"></i> Manage Connections
        </button>
        <button class="btn btn-sm btn-info" onclick="toggleConnections()">
            <i class="fas fa-eye"></i> <span id="toggle-connections-text">Hide Connections</span>
        </button>
        <label class="ms-3">
            <input type="checkbox" id="show-labels" checked onchange="toggleLabels()"> Show Labels
        </label>
    </div>

    {% if equipment %}
    <div id="map-canvas">
        <svg id="map-svg" width="100%" height="100%"></svg>
        
        {% for equip in equipment %}
        <div class="equipment-node status-{{ equip.status }}" 
             id="equipment-{{ equip.id }}"
             data-equipment-id="{{ equip.id }}"
             data-equipment-name="{{ equip.name }}"
             data-location-id="{{ equip.location.id }}"
             style="left: {{ forloop.counter0|add:50|divisibleby:5 }}px; top: {{ forloop.counter0|add:50|divisibleby:3 }}px;">
            <div class="equipment-node-name">{{ equip.name }}</div>
            <div class="equipment-node-location">{{ equip.location.name }}</div>
            <div class="equipment-node-status">{{ equip.get_status_display }}</div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-box-open fa-3x mb-3 text-muted"></i>
        <h4>No Equipment Found</h4>
        <p class="text-muted">No equipment has been configured yet.</p>
        <a href="{% url 'equipment:add_equipment' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Equipment
        </a>
    </div>
    {% endif %}
</div>

<!-- Connection Manager Modal -->
<div class="modal fade" id="connectionManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-link me-2"></i>Manage Equipment Connections
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connection-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="upstream-equipment" class="form-label">Upstream Equipment (Supplies)</label>
                                <select id="upstream-equipment" class="form-select" required>
                                    <option value="">Select equipment...</option>
                                    {% for equip in equipment %}
                                    <option value="{{ equip.id }}">{{ equip.name }} - {{ equip.location.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Equipment that provides power/data/service</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="downstream-equipment" class="form-label">Downstream Equipment (Depends)</label>
                                <select id="downstream-equipment" class="form-select" required>
                                    <option value="">Select equipment...</option>
                                    {% for equip in equipment %}
                                    <option value="{{ equip.id }}">{{ equip.name }} - {{ equip.location.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Equipment that depends on the upstream</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="connection-type" class="form-label">Connection Type</label>
                                <select id="connection-type" class="form-select" required>
                                    <option value="power">Power Supply</option>
                                    <option value="data">Data Connection</option>
                                    <option value="cooling">Cooling System</option>
                                    <option value="control">Control System</option>
                                    <option value="mechanical">Mechanical</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="is-critical" class="form-label">
                                    <input type="checkbox" id="is-critical" checked> Critical Connection
                                </label>
                                <small class="d-block text-muted">If checked, downstream goes offline when upstream fails</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="connection-description" class="form-label">Description (Optional)</label>
                        <textarea id="connection-description" class="form-control" rows="2"></textarea>
                    </div>
                </form>
                
                <hr>
                
                <h6><i class="fas fa-list me-2"></i>Existing Connections</h6>
                <div id="connections-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">
                    <i class="fas fa-save"></i> Create Connection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global state
let connections = {{ connections_json|safe }};
let equipmentData = {{ equipment_json|safe }};
let showConnections = true;
let isDragging = false;
let draggedNode = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

// Initialize map on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeMap();
    updateEquipmentStatus();
    drawConnections();
    loadExistingConnections();
});

function initializeMap() {
    const nodes = document.querySelectorAll('.equipment-node');
    
    // Make equipment draggable
    nodes.forEach(node => {
        node.addEventListener('mousedown', startDrag);
        node.addEventListener('click', showEquipmentDetails);
    });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
    
    // Auto layout on first load if no positions saved
    const savedPositions = localStorage.getItem('equipment-positions');
    if (!savedPositions) {
        autoLayout();
    } else {
        loadPositions();
    }
}

function startDrag(e) {
    if (e.target.classList.contains('equipment-node') || e.target.closest('.equipment-node')) {
        isDragging = true;
        draggedNode = e.target.classList.contains('equipment-node') ? e.target : e.target.closest('.equipment-node');
        const rect = draggedNode.getBoundingClientRect();
        const canvasRect = document.getElementById('map-canvas').getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        draggedNode.style.cursor = 'grabbing';
        e.preventDefault();
    }
}

function drag(e) {
    if (isDragging && draggedNode) {
        const canvas = document.getElementById('map-canvas');
        const canvasRect = canvas.getBoundingClientRect();
        
        let newX = e.clientX - canvasRect.left - dragOffsetX + canvas.scrollLeft;
        let newY = e.clientY - canvasRect.top - dragOffsetY + canvas.scrollTop;
        
        // Keep within bounds
        newX = Math.max(0, Math.min(newX, canvas.scrollWidth - draggedNode.offsetWidth));
        newY = Math.max(0, Math.min(newY, canvas.scrollHeight - draggedNode.offsetHeight));
        
        draggedNode.style.left = newX + 'px';
        draggedNode.style.top = newY + 'px';
        
        // Redraw connections
        drawConnections();
    }
}

function stopDrag(e) {
    if (isDragging && draggedNode) {
        isDragging = false;
        draggedNode.style.cursor = 'move';
        draggedNode = null;
        
        // Save positions
        savePositions();
    }
}

function drawConnections() {
    if (!showConnections) return;
    
    const svg = document.getElementById('map-svg');
    const canvas = document.getElementById('map-canvas');
    
    // Clear existing connections
    svg.innerHTML = '';
    
    // Set SVG size to match canvas
    svg.setAttribute('width', canvas.scrollWidth);
    svg.setAttribute('height', canvas.scrollHeight);
    
    // Draw each connection
    connections.forEach(conn => {
        const upstreamNode = document.getElementById('equipment-' + conn.upstream_id);
        const downstreamNode = document.getElementById('equipment-' + conn.downstream_id);
        
        if (!upstreamNode || !downstreamNode) return;
        
        // Get center points of nodes
        const upstreamRect = upstreamNode.getBoundingClientRect();
        const downstreamRect = downstreamNode.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();
        
        const x1 = upstreamRect.left - canvasRect.left + canvas.scrollLeft + upstreamRect.width / 2;
        const y1 = upstreamRect.top - canvasRect.top + canvas.scrollTop + upstreamRect.height / 2;
        const x2 = downstreamRect.left - canvasRect.left + canvas.scrollLeft + downstreamRect.width / 2;
        const y2 = downstreamRect.top - canvasRect.top + canvas.scrollTop + downstreamRect.height / 2;
        
        // Draw line with arrow
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        
        // Create a curved path
        const dx = x2 - x1;
        const dy = y2 - y1;
        const curve = Math.min(Math.abs(dx), Math.abs(dy)) * 0.3;
        
        const pathData = `M ${x1} ${y1} Q ${x1 + dx/2} ${y1 + dy/2 + curve}, ${x2} ${y2}`;
        line.setAttribute('d', pathData);
        line.setAttribute('class', conn.is_critical ? 'connection-line critical' : 'connection-line non-critical');
        
        // Add arrow marker
        const markerId = `arrow-${conn.id}`;
        createArrowMarker(svg, markerId, conn.is_critical);
        line.setAttribute('marker-end', `url(#${markerId})`);
        
        // Add title for tooltip
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${conn.connection_type.toUpperCase()}: ${conn.is_critical ? 'Critical' : 'Non-Critical'}`;
        line.appendChild(title);
        
        svg.appendChild(line);
    });
}

function createArrowMarker(svg, id, isCritical) {
    let defs = svg.querySelector('defs');
    if (!defs) {
        defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        svg.appendChild(defs);
    }
    
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
    marker.setAttribute('id', id);
    marker.setAttribute('markerWidth', '10');
    marker.setAttribute('markerHeight', '10');
    marker.setAttribute('refX', '9');
    marker.setAttribute('refY', '3');
    marker.setAttribute('orient', 'auto');
    marker.setAttribute('markerUnits', 'strokeWidth');
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M0,0 L0,6 L9,3 z');
    path.setAttribute('class', isCritical ? 'connection-arrow critical' : 'connection-arrow');
    
    marker.appendChild(path);
    defs.appendChild(marker);
}

function updateEquipmentStatus() {
    equipmentData.forEach(equip => {
        const node = document.getElementById('equipment-' + equip.id);
        if (node) {
            // Remove all status classes
            node.classList.remove('status-active', 'status-inactive', 'status-maintenance', 'status-retired', 'status-cascade-offline');
            
            // Add appropriate status class
            if (equip.is_cascade_offline) {
                node.classList.add('status-cascade-offline');
            } else {
                node.classList.add('status-' + equip.status);
            }
        }
    });
}

function autoLayout() {
    const nodes = document.querySelectorAll('.equipment-node');
    const canvas = document.getElementById('map-canvas');
    const canvasWidth = canvas.offsetWidth;
    const canvasHeight = canvas.offsetHeight;
    
    // Simple force-directed layout algorithm
    const nodeMap = new Map();
    nodes.forEach(node => {
        const equipId = parseInt(node.dataset.equipmentId);
        nodeMap.set(equipId, {
            node: node,
            x: Math.random() * (canvasWidth - 200) + 100,
            y: Math.random() * (canvasHeight - 100) + 50,
            vx: 0,
            vy: 0
        });
    });
    
    // Hierarchical layout based on connections
    const rootNodes = new Set(nodeMap.keys());
    connections.forEach(conn => {
        rootNodes.delete(conn.downstream_id);
    });
    
    // Position root nodes at the top
    let x = 100;
    let y = 50;
    const layerHeight = 150;
    const nodeSpacing = 220;
    
    // Simple layered layout
    const positioned = new Set();
    const layers = [];
    
    // Find nodes by layer (depth from root)
    function getLayer(equipId, depth = 0) {
        if (!layers[depth]) layers[depth] = [];
        if (positioned.has(equipId)) return;
        
        positioned.add(equipId);
        layers[depth].push(equipId);
        
        // Find downstream equipment
        connections.forEach(conn => {
            if (conn.upstream_id === equipId) {
                getLayer(conn.downstream_id, depth + 1);
            }
        });
    }
    
    // Build layers starting from root nodes
    rootNodes.forEach(rootId => getLayer(rootId, 0));
    
    // Position nodes by layer
    layers.forEach((layer, layerIndex) => {
        const layerY = 50 + (layerIndex * layerHeight);
        const totalWidth = layer.length * nodeSpacing;
        let startX = Math.max(100, (canvasWidth - totalWidth) / 2);
        
        layer.forEach((equipId, index) => {
            const data = nodeMap.get(equipId);
            if (data) {
                data.x = startX + (index * nodeSpacing);
                data.y = layerY;
                data.node.style.left = data.x + 'px';
                data.node.style.top = data.y + 'px';
            }
        });
    });
    
    savePositions();
    drawConnections();
}

function resetPositions() {
    localStorage.removeItem('equipment-positions');
    autoLayout();
}

function savePositions() {
    const positions = {};
    document.querySelectorAll('.equipment-node').forEach(node => {
        const equipId = node.dataset.equipmentId;
        positions[equipId] = {
            left: node.style.left,
            top: node.style.top
        };
    });
    localStorage.setItem('equipment-positions', JSON.stringify(positions));
}

function loadPositions() {
    const savedPositions = localStorage.getItem('equipment-positions');
    if (savedPositions) {
        const positions = JSON.parse(savedPositions);
        Object.keys(positions).forEach(equipId => {
            const node = document.getElementById('equipment-' + equipId);
            if (node && positions[equipId]) {
                node.style.left = positions[equipId].left;
                node.style.top = positions[equipId].top;
            }
        });
        drawConnections();
    }
}

function toggleConnections() {
    showConnections = !showConnections;
    const svg = document.getElementById('map-svg');
    svg.style.display = showConnections ? 'block' : 'none';
    document.getElementById('toggle-connections-text').textContent = showConnections ? 'Hide Connections' : 'Show Connections';
}

function toggleLabels() {
    const showLabels = document.getElementById('show-labels').checked;
    document.querySelectorAll('.equipment-node-location, .equipment-node-status').forEach(el => {
        el.style.display = showLabels ? 'block' : 'none';
    });
}

function showEquipmentDetails(e) {
    if (isDragging) return;
    
    const node = e.target.classList.contains('equipment-node') ? e.target : e.target.closest('.equipment-node');
    if (node) {
        const equipId = node.dataset.equipmentId;
        window.location.href = `/equipment/equipment/${equipId}/`;
    }
}

function showConnectionManager() {
    loadExistingConnections();
    const modal = new bootstrap.Modal(document.getElementById('connectionManagerModal'));
    modal.show();
}

function loadExistingConnections() {
    const listEl = document.getElementById('connections-list');
    if (connections.length === 0) {
        listEl.innerHTML = '<p class="text-muted">No connections defined yet.</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    connections.forEach(conn => {
        const upstream = equipmentData.find(e => e.id === conn.upstream_id);
        const downstream = equipmentData.find(e => e.id === conn.downstream_id);
        
        if (upstream && downstream) {
            html += `
                <div class="list-group-item bg-secondary text-light mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${upstream.name}</strong> 
                            <i class="fas fa-arrow-right mx-2"></i> 
                            <strong>${downstream.name}</strong>
                            <br>
                            <small class="text-muted">
                                ${conn.connection_type} | ${conn.is_critical ? 'Critical' : 'Non-Critical'}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteConnection(${conn.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }
    });
    html += '</div>';
    listEl.innerHTML = html;
}

function saveConnection() {
    const upstreamId = document.getElementById('upstream-equipment').value;
    const downstreamId = document.getElementById('downstream-equipment').value;
    const connectionType = document.getElementById('connection-type').value;
    const isCritical = document.getElementById('is-critical').checked;
    const description = document.getElementById('connection-description').value;
    
    if (!upstreamId || !downstreamId) {
        alert('Please select both upstream and downstream equipment.');
        return;
    }
    
    if (upstreamId === downstreamId) {
        alert('Equipment cannot connect to itself.');
        return;
    }
    
    // Create connection via API
    fetch('/equipment/api/connections/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            upstream_equipment: upstreamId,
            downstream_equipment: downstreamId,
            connection_type: connectionType,
            is_critical: isCritical,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Add to local connections
            connections.push({
                id: data.connection.id,
                upstream_id: parseInt(upstreamId),
                downstream_id: parseInt(downstreamId),
                connection_type: connectionType,
                is_critical: isCritical
            });
            
            // Redraw
            drawConnections();
            loadExistingConnections();
            
            // Clear form
            document.getElementById('connection-form').reset();
            
            // Show success message
            if (window.showMessage) {
                window.showMessage('Connection created successfully!', 'success');
            } else {
                alert('Connection created successfully!');
            }
        } else {
            alert('Error creating connection: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating connection. Check console for details.');
    });
}

function deleteConnection(connectionId) {
    if (!confirm('Are you sure you want to delete this connection?')) return;
    
    fetch(`/equipment/api/connections/${connectionId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Remove from local connections
            connections = connections.filter(c => c.id !== connectionId);
            
            // Redraw
            drawConnections();
            loadExistingConnections();
            
            // Show success message
            if (window.showMessage) {
                window.showMessage('Connection deleted successfully!', 'success');
            } else {
                alert('Connection deleted successfully!');
            }
        } else {
            alert('Error deleting connection: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting connection. Check console for details.');
    });
}

function showEquipmentDetails(e) {
    if (isDragging) return;
    // Prevent navigation if clicking drag handle area
    if (e.target.tagName === 'BUTTON') return;
    
    const node = e.target.classList.contains('equipment-node') ? e.target : e.target.closest('.equipment-node');
    if (node) {
        const equipId = node.dataset.equipmentId;
        window.open(`/equipment/equipment/${equipId}/`, '_blank');
    }
}

// Redraw connections when window resizes
window.addEventListener('resize', drawConnections);
</script>
{% endblock %}
