{% extends 'base.html' %}
{% load static %}

{% block title %}Map - Equipment Dependency Diagram{% endblock %}

{% block extra_css %}
<style>
.map-container {
    background-color: #1a2238;
    min-height: 100vh;
    color: white;
    padding: 20px;
}

.map-header {
    background-color: #0f1419;
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-bottom: 1px solid #2d3748;
}

.customer-map-section {
    background-color: #2d3748;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    border: 2px solid #4a5568;
}

.customer-map-header {
    background-color: #0f1419;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid var(--primary-color, #4299e1);
}

.map-canvas {
    position: relative;
    width: 100%;
    min-height: 500px;
    background-color: #1a2238;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #4a5568;
}

.map-svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    z-index: 1;
    width: 100%;
    height: 100%;
}

.equipment-node {
    position: absolute;
    background-color: var(--success-color, #48bb78);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    cursor: move;
    transition: all 0.3s ease;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    min-width: 150px;
    text-align: center;
    user-select: none;
}

.equipment-node:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    z-index: 3;
}

.equipment-node.status-active {
    background-color: var(--success-color, #48bb78);
    border: 2px solid #2f855a;
}

.equipment-node.status-inactive {
    background-color: #718096;
    border: 2px solid #4a5568;
}

.equipment-node.status-maintenance {
    background-color: var(--warning-color, #ed8936);
    border: 2px solid #c05621;
}

.equipment-node.status-retired {
    background-color: #4a5568;
    border: 2px solid #2d3748;
}

.equipment-node.status-cascade-offline {
    background-color: var(--danger-color, #f56565);
    border: 2px solid #c53030;
    animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.equipment-node-name {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 4px;
}

.equipment-node-location {
    font-size: 11px;
    opacity: 0.8;
}

.equipment-node-status {
    font-size: 10px;
    margin-top: 4px;
    padding: 2px 6px;
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

.connection-line {
    stroke-width: 2;
    fill: none;
    pointer-events: none;
}

.connection-line.critical {
    stroke: var(--danger-color, #f56565);
    stroke-width: 3;
}

.connection-line.non-critical {
    stroke: var(--info-color, #4299e1);
    stroke-width: 2;
    stroke-dasharray: 5,5;
}

.connection-arrow {
    fill: var(--info-color, #4299e1);
}

.connection-arrow.critical {
    fill: var(--danger-color, #f56565);
}

.legend {
    background-color: #0f1419;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.legend-item {
    display: inline-flex;
    align-items: center;
    margin-right: 20px;
    margin-bottom: 8px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    margin-right: 8px;
}

.legend-line {
    width: 40px;
    height: 3px;
    margin-right: 8px;
}

.legend-line.dashed {
    background: repeating-linear-gradient(
        to right,
        var(--info-color, #4299e1) 0,
        var(--info-color, #4299e1) 5px,
        transparent 5px,
        transparent 10px
    );
}

.map-controls {
    background-color: #0f1419;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.map-controls .btn {
    margin-right: 10px;
    margin-bottom: 5px;
}

.customer-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.stat-box {
    background-color: #2d3748;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
    border: 1px solid #4a5568;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
}

.stat-label {
    font-size: 11px;
    opacity: 0.7;
    text-transform: uppercase;
}
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="map-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0">
                    <i class="fas fa-project-diagram me-2"></i>
                    Equipment Dependency Maps
                </h2>
                <p class="mb-0 text-light">Customer-specific equipment connections and dependencies</p>
            </div>
            <div>
                <select class="form-select" onchange="filterByCustomer(this.value)" style="min-width: 200px;">
                    <option value="all" {% if selected_customer_id == 'all' %}selected{% endif %}>All Customers</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if selected_customer_id|stringformat:"s" == customer.id|stringformat:"s" %}selected{% endif %}>
                        {{ customer.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="legend">
        <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Legend</h5>
        <div class="row">
            <div class="col-md-6">
                <strong>Equipment Status:</strong>
                <div class="mt-2">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--success-color, #48bb78);"></div>
                        <span>Active</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--warning-color, #ed8936);"></div>
                        <span>Under Maintenance</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #718096;"></div>
                        <span>Inactive</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--danger-color, #f56565);"></div>
                        <span>Cascade Offline</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <strong>Connection Types:</strong>
                <div class="mt-2">
                    <div class="legend-item">
                        <div class="legend-line" style="background-color: var(--danger-color, #f56565); height: 3px;"></div>
                        <span>Critical (Cascades Offline)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line dashed"></div>
                        <span>Non-Critical (Independent)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="map-controls">
        <strong><i class="fas fa-tools me-2"></i>Tools:</strong>
        <button class="btn btn-sm btn-primary" onclick="showConnectionManager()">
            <i class="fas fa-link"></i> Manage Connections
        </button>
        <button class="btn btn-sm btn-success" onclick="autoLayoutAll()">
            <i class="fas fa-magic"></i> Auto Layout All
        </button>
        <button class="btn btn-sm btn-info" onclick="toggleAllConnections()">
            <i class="fas fa-eye"></i> <span id="toggle-connections-text">Hide Connections</span>
        </button>
        <button class="btn btn-sm btn-warning" onclick="resetAllPositions()">
            <i class="fas fa-undo"></i> Reset All
        </button>
        <label class="ms-3">
            <input type="checkbox" id="show-labels" checked onchange="toggleLabels()"> Show Labels
        </label>
    </div>

    {% if customer_maps %}
        {% for customer_map in customer_maps %}
        <div class="customer-map-section" id="customer-{{ customer_map.customer.id }}">
            <div class="customer-map-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">
                            <i class="fas fa-building me-2"></i>{{ customer_map.customer.name }}
                        </h3>
                        <p class="mb-0 text-muted small">
                            {{ customer_map.equipment.count }} equipment | {{ customer_map.connections.count }} connections
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="autoLayoutCustomer('{{ customer_map.customer.id }}')">
                            <i class="fas fa-magic"></i> Auto Layout
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="resetCustomerPositions('{{ customer_map.customer.id }}')">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="customer-stats">
                    <div class="stat-box">
                        <div class="stat-value text-success">{{ customer_map.equipment|length }}</div>
                        <div class="stat-label">Total Equipment</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value text-danger">
                            {% with offline_count=0 %}
                                {% for equip in customer_map.equipment %}
                                    {% if equip.get_effective_status == 'cascade_offline' or equip.get_effective_status == 'inactive' %}
                                        {% with offline_count=offline_count|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                                {{ offline_count }}
                            {% endwith %}
                        </div>
                        <div class="stat-label">Offline</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value text-warning">
                            {% with maint_count=0 %}
                                {% for equip in customer_map.equipment %}
                                    {% if equip.status == 'maintenance' %}
                                        {% with maint_count=maint_count|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                                {{ maint_count }}
                            {% endwith %}
                        </div>
                        <div class="stat-label">Maintenance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value text-info">{{ customer_map.locations.count }}</div>
                        <div class="stat-label">Locations</div>
                    </div>
                </div>
            </div>
            
            <div class="map-canvas" id="map-canvas-{{ customer_map.customer.id }}" data-customer-id="{{ customer_map.customer.id }}">
                <svg class="map-svg" id="map-svg-{{ customer_map.customer.id }}" width="100%" height="100%"></svg>
                
                {% for equip in customer_map.equipment %}
                <div class="equipment-node status-{{ equip.status }}" 
                     id="equipment-{{ customer_map.customer.id }}-{{ equip.id }}"
                     data-customer-id="{{ customer_map.customer.id }}"
                     data-equipment-id="{{ equip.id }}"
                     data-equipment-name="{{ equip.name }}"
                     data-location-id="{{ equip.location.id }}"
                     style="left: 100px; top: {{ forloop.counter0|add:1|divisibleby:3|add:50 }}px;">
                    <div class="equipment-node-name">{{ equip.name }}</div>
                    <div class="equipment-node-location">{{ equip.location.name }}</div>
                    <div class="equipment-node-status">{{ equip.get_status_display }}</div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Store data for this customer's map -->
            <script>
                if (!window.customerMapData) window.customerMapData = {};
                window.customerMapData['{{ customer_map.customer.id }}'] = {
                    connections: {{ customer_map.connections_json|safe }},
                    equipment: {{ customer_map.equipment_json|safe }}
                };
            </script>
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-building fa-3x mb-3 text-muted"></i>
            <h4>No Customer Maps Available</h4>
            <p class="text-muted">No customers with equipment have been configured yet.</p>
            <div class="mt-3">
                <a href="{% url 'core:customers_settings' %}" class="btn btn-primary me-2">
                    <i class="fas fa-user-plus me-1"></i>Add Customers
                </a>
                <a href="{% url 'equipment:add_equipment' %}" class="btn btn-success">
                    <i class="fas fa-cogs me-1"></i>Add Equipment
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Connection Manager Modal -->
<div class="modal fade" id="connectionManagerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-link me-2"></i>Manage Equipment Connections
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connection-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="upstream-equipment" class="form-label">Upstream Equipment (Supplies)</label>
                                <select id="upstream-equipment" class="form-select" required>
                                    <option value="">Select equipment...</option>
                                    {% for equip in all_equipment %}
                                    <option value="{{ equip.id }}">{{ equip.name }} - {{ equip.location.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Equipment that provides power/data/service</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="downstream-equipment" class="form-label">Downstream Equipment (Depends)</label>
                                <select id="downstream-equipment" class="form-select" required>
                                    <option value="">Select equipment...</option>
                                    {% for equip in all_equipment %}
                                    <option value="{{ equip.id }}">{{ equip.name }} - {{ equip.location.name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Equipment that depends on the upstream</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="connection-type" class="form-label">Connection Type</label>
                                <select id="connection-type" class="form-select" required>
                                    <option value="power">Power Supply</option>
                                    <option value="data">Data Connection</option>
                                    <option value="cooling">Cooling System</option>
                                    <option value="control">Control System</option>
                                    <option value="mechanical">Mechanical</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label d-block">
                                    <input type="checkbox" id="is-critical" checked> Critical Connection
                                </label>
                                <small class="d-block text-muted">If checked, downstream goes offline when upstream fails</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="connection-description" class="form-label">Description (Optional)</label>
                        <textarea id="connection-description" class="form-control" rows="2"></textarea>
                    </div>
                </form>
                
                <hr>
                
                <h6><i class="fas fa-list me-2"></i>All Existing Connections</h6>
                <div id="connections-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">
                    <i class="fas fa-save"></i> Create Connection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global state
let showConnectionsGlobal = true;

// Initialize all maps on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeAllMaps();
});

function initializeAllMaps() {
    if (!window.customerMapData) return;
    
    Object.keys(window.customerMapData).forEach(customerId => {
        initializeCustomerMap(customerId);
    });
    
    loadExistingConnections();
}

function initializeCustomerMap(customerId) {
    const canvas = document.getElementById(`map-canvas-${customerId}`);
    if (!canvas) return;
    
    const nodes = canvas.querySelectorAll('.equipment-node');
    
    // Make equipment draggable
    nodes.forEach(node => {
        node.addEventListener('mousedown', startDrag);
        node.addEventListener('click', showEquipmentDetails);
    });
    
    // Load saved positions or auto-layout
    const savedPositions = localStorage.getItem(`equipment-positions-${customerId}`);
    if (!savedPositions) {
        autoLayoutCustomer(customerId);
    } else {
        loadCustomerPositions(customerId);
    }
    
    updateCustomerEquipmentStatus(customerId);
    drawCustomerConnections(customerId);
}

let isDragging = false;
let draggedNode = null;
let dragOffsetX = 0;
let dragOffsetY = 0;

function startDrag(e) {
    if (e.target.classList.contains('equipment-node') || e.target.closest('.equipment-node')) {
        isDragging = true;
        draggedNode = e.target.classList.contains('equipment-node') ? e.target : e.target.closest('.equipment-node');
        const rect = draggedNode.getBoundingClientRect();
        const customerId = draggedNode.dataset.customerId;
        const canvas = document.getElementById(`map-canvas-${customerId}`);
        const canvasRect = canvas.getBoundingClientRect();
        dragOffsetX = e.clientX - rect.left;
        dragOffsetY = e.clientY - rect.top;
        draggedNode.style.cursor = 'grabbing';
        e.preventDefault();
    }
}

document.addEventListener('mousemove', function(e) {
    if (isDragging && draggedNode) {
        const customerId = draggedNode.dataset.customerId;
        const canvas = document.getElementById(`map-canvas-${customerId}`);
        const canvasRect = canvas.getBoundingClientRect();
        
        let newX = e.clientX - canvasRect.left - dragOffsetX;
        let newY = e.clientY - canvasRect.top - dragOffsetY;
        
        // Keep within bounds
        newX = Math.max(0, Math.min(newX, canvas.offsetWidth - draggedNode.offsetWidth));
        newY = Math.max(0, Math.min(newY, canvas.offsetHeight - draggedNode.offsetHeight));
        
        draggedNode.style.left = newX + 'px';
        draggedNode.style.top = newY + 'px';
        
        // Redraw connections for this customer
        drawCustomerConnections(customerId);
    }
});

document.addEventListener('mouseup', function(e) {
    if (isDragging && draggedNode) {
        const customerId = draggedNode.dataset.customerId;
        isDragging = false;
        draggedNode.style.cursor = 'move';
        draggedNode = null;
        
        // Save positions
        saveCustomerPositions(customerId);
    }
});

function drawCustomerConnections(customerId) {
    if (!showConnectionsGlobal) return;
    if (!window.customerMapData || !window.customerMapData[customerId]) return;
    
    const svg = document.getElementById(`map-svg-${customerId}`);
    const canvas = document.getElementById(`map-canvas-${customerId}`);
    const connections = window.customerMapData[customerId].connections;
    
    if (!svg || !canvas) return;
    
    // Clear existing connections
    svg.innerHTML = '';
    
    // Draw each connection
    connections.forEach(conn => {
        const upstreamNode = document.getElementById(`equipment-${customerId}-${conn.upstream_id}`);
        const downstreamNode = document.getElementById(`equipment-${customerId}-${conn.downstream_id}`);
        
        if (!upstreamNode || !downstreamNode) return;
        
        // Get center points of nodes relative to canvas
        const canvasRect = canvas.getBoundingClientRect();
        const upstreamRect = upstreamNode.getBoundingClientRect();
        const downstreamRect = downstreamNode.getBoundingClientRect();
        
        const x1 = upstreamRect.left - canvasRect.left + upstreamRect.width / 2;
        const y1 = upstreamRect.top - canvasRect.top + upstreamRect.height / 2;
        const x2 = downstreamRect.left - canvasRect.left + downstreamRect.width / 2;
        const y2 = downstreamRect.top - canvasRect.top + downstreamRect.height / 2;
        
        // Draw curved line with arrow
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        
        const dx = x2 - x1;
        const dy = y2 - y1;
        const curve = Math.min(Math.abs(dx), Math.abs(dy)) * 0.3;
        
        const pathData = `M ${x1} ${y1} Q ${x1 + dx/2} ${y1 + dy/2 + curve}, ${x2} ${y2}`;
        line.setAttribute('d', pathData);
        line.setAttribute('class', conn.is_critical ? 'connection-line critical' : 'connection-line non-critical');
        
        // Add arrow marker
        const markerId = `arrow-${customerId}-${conn.id}`;
        createArrowMarker(svg, markerId, conn.is_critical);
        line.setAttribute('marker-end', `url(#${markerId})`);
        
        // Add title for tooltip
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        title.textContent = `${conn.connection_type.toUpperCase()}: ${conn.is_critical ? 'Critical' : 'Non-Critical'}`;
        line.appendChild(title);
        
        svg.appendChild(line);
    });
}

function createArrowMarker(svg, id, isCritical) {
    let defs = svg.querySelector('defs');
    if (!defs) {
        defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        svg.appendChild(defs);
    }
    
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
    marker.setAttribute('id', id);
    marker.setAttribute('markerWidth', '10');
    marker.setAttribute('markerHeight', '10');
    marker.setAttribute('refX', '9');
    marker.setAttribute('refY', '3');
    marker.setAttribute('orient', 'auto');
    marker.setAttribute('markerUnits', 'strokeWidth');
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', 'M0,0 L0,6 L9,3 z');
    path.setAttribute('class', isCritical ? 'connection-arrow critical' : 'connection-arrow');
    
    marker.appendChild(path);
    defs.appendChild(marker);
}

function updateCustomerEquipmentStatus(customerId) {
    if (!window.customerMapData || !window.customerMapData[customerId]) return;
    
    const equipmentData = window.customerMapData[customerId].equipment;
    
    equipmentData.forEach(equip => {
        const node = document.getElementById(`equipment-${customerId}-${equip.id}`);
        if (node) {
            // Remove all status classes
            node.classList.remove('status-active', 'status-inactive', 'status-maintenance', 'status-retired', 'status-cascade-offline');
            
            // Add appropriate status class
            if (equip.is_cascade_offline) {
                node.classList.add('status-cascade-offline');
            } else {
                node.classList.add('status-' + equip.status);
            }
        }
    });
}

function autoLayoutCustomer(customerId) {
    const canvas = document.getElementById(`map-canvas-${customerId}`);
    if (!canvas || !window.customerMapData || !window.customerMapData[customerId]) return;
    
    const nodes = canvas.querySelectorAll('.equipment-node');
    const connections = window.customerMapData[customerId].connections;
    const canvasWidth = canvas.offsetWidth;
    
    // Build node map
    const nodeMap = new Map();
    nodes.forEach(node => {
        const equipId = parseInt(node.dataset.equipmentId);
        nodeMap.set(equipId, { node: node, x: 0, y: 0 });
    });
    
    // Find root nodes (no upstream connections)
    const rootNodes = new Set(nodeMap.keys());
    connections.forEach(conn => {
        rootNodes.delete(conn.downstream_id);
    });
    
    // Build layers
    const positioned = new Set();
    const layers = [];
    
    function getLayer(equipId, depth = 0) {
        if (!layers[depth]) layers[depth] = [];
        if (positioned.has(equipId)) return;
        
        positioned.add(equipId);
        layers[depth].push(equipId);
        
        // Find downstream equipment
        connections.forEach(conn => {
            if (conn.upstream_id === equipId && !positioned.has(conn.downstream_id)) {
                getLayer(conn.downstream_id, depth + 1);
            }
        });
    }
    
    // Build layers starting from root nodes
    rootNodes.forEach(rootId => getLayer(rootId, 0));
    
    // Add any unconnected nodes to first layer
    nodeMap.forEach((data, equipId) => {
        if (!positioned.has(equipId)) {
            if (!layers[0]) layers[0] = [];
            layers[0].push(equipId);
        }
    });
    
    // Position nodes by layer
    const layerHeight = 150;
    const nodeSpacing = 200;
    
    layers.forEach((layer, layerIndex) => {
        const layerY = 50 + (layerIndex * layerHeight);
        const totalWidth = layer.length * nodeSpacing;
        let startX = Math.max(50, (canvasWidth - totalWidth) / 2);
        
        layer.forEach((equipId, index) => {
            const data = nodeMap.get(equipId);
            if (data) {
                data.x = startX + (index * nodeSpacing);
                data.y = layerY;
                data.node.style.left = data.x + 'px';
                data.node.style.top = data.y + 'px';
            }
        });
    });
    
    saveCustomerPositions(customerId);
    drawCustomerConnections(customerId);
}

function autoLayoutAll() {
    Object.keys(window.customerMapData || {}).forEach(customerId => {
        autoLayoutCustomer(customerId);
    });
}

function resetCustomerPositions(customerId) {
    localStorage.removeItem(`equipment-positions-${customerId}`);
    autoLayoutCustomer(customerId);
}

function resetAllPositions() {
    Object.keys(window.customerMapData || {}).forEach(customerId => {
        resetCustomerPositions(customerId);
    });
}

function saveCustomerPositions(customerId) {
    const canvas = document.getElementById(`map-canvas-${customerId}`);
    if (!canvas) return;
    
    const positions = {};
    canvas.querySelectorAll('.equipment-node').forEach(node => {
        const equipId = node.dataset.equipmentId;
        positions[equipId] = {
            left: node.style.left,
            top: node.style.top
        };
    });
    localStorage.setItem(`equipment-positions-${customerId}`, JSON.stringify(positions));
}

function loadCustomerPositions(customerId) {
    const savedPositions = localStorage.getItem(`equipment-positions-${customerId}`);
    if (!savedPositions) return;
    
    const positions = JSON.parse(savedPositions);
    Object.keys(positions).forEach(equipId => {
        const node = document.getElementById(`equipment-${customerId}-${equipId}`);
        if (node && positions[equipId]) {
            node.style.left = positions[equipId].left;
            node.style.top = positions[equipId].top;
        }
    });
    drawCustomerConnections(customerId);
}

function toggleAllConnections() {
    showConnectionsGlobal = !showConnectionsGlobal;
    
    document.querySelectorAll('.map-svg').forEach(svg => {
        svg.style.display = showConnectionsGlobal ? 'block' : 'none';
    });
    
    document.getElementById('toggle-connections-text').textContent = 
        showConnectionsGlobal ? 'Hide Connections' : 'Show Connections';
}

function toggleLabels() {
    const showLabels = document.getElementById('show-labels').checked;
    document.querySelectorAll('.equipment-node-location, .equipment-node-status').forEach(el => {
        el.style.display = showLabels ? 'block' : 'none';
    });
}

function showEquipmentDetails(e) {
    if (isDragging) return;
    if (e.target.tagName === 'BUTTON') return;
    
    const node = e.target.classList.contains('equipment-node') ? e.target : e.target.closest('.equipment-node');
    if (node) {
        const equipId = node.dataset.equipmentId;
        window.open(`/equipment/${equipId}/`, '_blank');
    }
}

function filterByCustomer(customerId) {
    const currentUrl = new URL(window.location.href);
    if (customerId === 'all') {
        currentUrl.searchParams.delete('customer_id');
    } else {
        currentUrl.searchParams.set('customer_id', customerId);
    }
    window.location.href = currentUrl.toString();
}

function showConnectionManager() {
    loadExistingConnections();
    const modal = new bootstrap.Modal(document.getElementById('connectionManagerModal'));
    modal.show();
}

function loadExistingConnections() {
    const listEl = document.getElementById('connections-list');
    if (!window.customerMapData) {
        listEl.innerHTML = '<p class="text-muted">No connections defined yet.</p>';
        return;
    }
    
    // Collect all connections from all customers
    let allConnections = [];
    Object.keys(window.customerMapData).forEach(customerId => {
        const data = window.customerMapData[customerId];
        data.connections.forEach(conn => {
            const upstream = data.equipment.find(e => e.id === conn.upstream_id);
            const downstream = data.equipment.find(e => e.id === conn.downstream_id);
            if (upstream && downstream) {
                allConnections.push({
                    ...conn,
                    upstream_name: upstream.name,
                    downstream_name: downstream.name,
                    customerId: customerId
                });
            }
        });
    });
    
    if (allConnections.length === 0) {
        listEl.innerHTML = '<p class="text-muted">No connections defined yet.</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    allConnections.forEach(conn => {
        html += `
            <div class="list-group-item bg-secondary text-light mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${conn.upstream_name}</strong> 
                        <i class="fas fa-arrow-right mx-2"></i> 
                        <strong>${conn.downstream_name}</strong>
                        <br>
                        <small class="text-muted">
                            ${conn.connection_type} | ${conn.is_critical ? 'Critical' : 'Non-Critical'}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteConnection(${conn.id}, '${conn.customerId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    listEl.innerHTML = html;
}

function saveConnection() {
    const upstreamId = document.getElementById('upstream-equipment').value;
    const downstreamId = document.getElementById('downstream-equipment').value;
    const connectionType = document.getElementById('connection-type').value;
    const isCritical = document.getElementById('is-critical').checked;
    const description = document.getElementById('connection-description').value;
    
    if (!upstreamId || !downstreamId) {
        alert('Please select both upstream and downstream equipment.');
        return;
    }
    
    if (upstreamId === downstreamId) {
        alert('Equipment cannot connect to itself.');
        return;
    }
    
    // Create connection via API
    fetch('/equipment/api/connections/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            upstream_equipment: upstreamId,
            downstream_equipment: downstreamId,
            connection_type: connectionType,
            is_critical: isCritical,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Reload page to show new connection
            if (window.showMessage) {
                window.showMessage('Connection created successfully! Reloading...', 'success');
            }
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert('Error creating connection: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating connection. Check console for details.');
    });
}

function deleteConnection(connectionId, customerId) {
    if (!confirm('Are you sure you want to delete this connection?')) return;
    
    fetch(`/equipment/api/connections/${connectionId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Reload page to update connections
            if (window.showMessage) {
                window.showMessage('Connection deleted successfully! Reloading...', 'success');
            }
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert('Error deleting connection: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting connection. Check console for details.');
    });
}

// Redraw all connections when window resizes
window.addEventListener('resize', function() {
    Object.keys(window.customerMapData || {}).forEach(customerId => {
        drawCustomerConnections(customerId);
    });
});
</script>
{% endblock %}
