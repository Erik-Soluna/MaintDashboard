{% extends 'base.html' %}
{% load static %}

{% block title %}Set Version Information{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- GitHub URL Input Section - Made More Prominent -->
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-github me-2"></i>üöÄ Quick Version from GitHub</h4>
                </div>
                <div class="card-body">
                    <p class="lead mb-3">Simply paste a GitHub URL and get version information automatically!</p>
                    
                    <div class="input-group input-group-lg mb-3">
                        <span class="input-group-text"><i class="fas fa-link"></i></span>
                        <input type="url" class="form-control" id="url_input" 
                               placeholder="https://github.com/Erik-Soluna/MaintDashboard/tree/latest"
                               aria-label="GitHub URL">
                        <button class="btn btn-primary btn-lg" type="button" onclick="extractFromUrl()">
                            <i class="fas fa-magic me-2"></i>Extract Version
                        </button>
                    </div>
                    
                    <div id="url_result" class="mt-3"></div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb me-2"></i>üí° Quick Examples:</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-secondary btn-sm text-start" 
                                        onclick="setExampleUrl('https://github.com/Erik-Soluna/MaintDashboard/tree/latest')">
                                    <strong>Latest Branch:</strong> github.com/Erik-Soluna/MaintDashboard/tree/latest
                                </button>
                                <button class="btn btn-outline-secondary btn-sm text-start" 
                                        onclick="setExampleUrl('https://github.com/Erik-Soluna/MaintDashboard')">
                                    <strong>Main Branch:</strong> github.com/Erik-Soluna/MaintDashboard
                                </button>
                                <button class="btn btn-outline-secondary btn-sm text-start" 
                                        onclick="setExampleUrl('https://github.com/Erik-Soluna/MaintDashboard/commit/65462d3')">
                                    <strong>Specific Commit:</strong> github.com/Erik-Soluna/MaintDashboard/commit/65462d3
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle me-2"></i>üìã Supported URL Formats:</h6>
                            <ul class="list-unstyled small">
                                <li>‚úÖ <strong>Branch:</strong> github.com/user/repo/tree/branch</li>
                                <li>‚úÖ <strong>Simple Branch:</strong> github.com/user/repo/branch</li>
                                <li>‚úÖ <strong>Repository:</strong> github.com/user/repo</li>
                                <li>‚úÖ <strong>Commit:</strong> github.com/user/repo/commit/hash</li>
                                <li>‚úÖ <strong>GitLab:</strong> gitlab.com/user/repo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            
            <!-- Manual Input Section -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Manual Version Input</h5>
                </div>
                <div class="card-body">
                    <form id="versionForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="commit_count" class="form-label">Commit Count</label>
                                    <input type="number" class="form-control" id="commit_count" name="commit_count" required>
                                    <div class="form-text">Total number of commits in the repository</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="commit_hash" class="form-label">Commit Hash</label>
                                    <input type="text" class="form-control" id="commit_hash" name="commit_hash" maxlength="7" required>
                                    <div class="form-text">Short commit hash (7 characters)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="branch" class="form-label">Branch</label>
                                    <input type="text" class="form-control" id="branch" name="branch" required>
                                    <div class="form-text">Branch name (e.g., main, latest, develop)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="commit_date" class="form-label">Commit Date</label>
                                    <input type="date" class="form-control" id="commit_date" name="commit_date" required>
                                    <div class="form-text">Date of the commit (YYYY-MM-DD)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Set Version
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadCurrentVersion()">
                                <i class="fas fa-sync me-1"></i>Load Current Version
                            </button>
                        </div>
                    </form>
                    
                    <div id="result" class="mt-3"></div>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Version Links</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Click these links to quickly set common version information:</p>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="setVersionFromLink('123', 'abc1234', 'main', '2024-01-15')">
                            v123.abc1234 (main)
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="setVersionFromLink('456', 'def5678', 'develop', '2024-01-16')">
                            v456.def5678 (develop)
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="setVersionFromLink('789', 'ghi9012', 'feature', '2024-01-17')">
                            v789.ghi9012 (feature)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Set example URL function
function setExampleUrl(url) {
    document.getElementById('url_input').value = url;
    // Auto-extract after setting example
    setTimeout(() => extractFromUrl(), 500);
}

document.getElementById('versionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // Validate commit_count before sending
    let commitCount = formData.get('commit_count');
    if (!commitCount || commitCount.trim() === '' || isNaN(commitCount) || commitCount.includes('/')) {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Validation Error</h6>
                <p class="mb-0">Commit count must be a valid number. Current value: "${commitCount}"</p>
            </div>
        `;
        return;
    }
    
    // Ensure it's a positive integer
    commitCount = parseInt(commitCount);
    if (commitCount <= 0) {
        commitCount = 1;
    }
    
    const data = {
        commit_count: commitCount,
        commit_hash: formData.get('commit_hash'),
        branch: formData.get('branch'),
        commit_date: formData.get('commit_date')
    };
    
    fetch('/version/set/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('result');
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ Version Set Successfully!</h6>
                    <p class="mb-1"><strong>Version:</strong> ${data.version_info.version}</p>
                    <p class="mb-1"><strong>Commit:</strong> ${data.version_info.commit_hash}</p>
                    <p class="mb-1"><strong>Branch:</strong> ${data.version_info.branch}</p>
                    <p class="mb-1"><strong>Date:</strong> ${data.version_info.commit_date}</p>
                    <p class="mb-0"><strong>Full:</strong> ${data.version_info.full_version}</p>
                </div>
            `;
            
            // Clear form
            document.getElementById('versionForm').reset();
            
            // Refresh page after 2 seconds to show new version
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>‚ùå Error Setting Version</h6>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Network Error</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    });
});

function setVersionFromLink(commitCount, commitHash, branch, commitDate) {
    // Validate commit count before setting
    if (!commitCount || isNaN(commitCount) || String(commitCount).includes('/')) {
        alert(`Invalid commit count: "${commitCount}". Using fallback value 1.`);
        commitCount = 1;
    }
    
    document.getElementById('commit_count').value = parseInt(commitCount);
    document.getElementById('commit_hash').value = commitHash;
    document.getElementById('branch').value = branch;
    document.getElementById('commit_date').value = commitDate;
}

function loadCurrentVersion() {
    fetch('/version/')
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error loading current version: ' + data.error);
            return;
        }
        
        // Validate commit count before setting
        let commitCount = data.commit_count;
        if (!commitCount || isNaN(commitCount) || String(commitCount).includes('/')) {
            alert(`Invalid commit count from server: "${commitCount}". Using fallback value 1.`);
            commitCount = 1;
        }
        
        document.getElementById('commit_count').value = parseInt(commitCount);
        document.getElementById('commit_hash').value = data.commit_hash || 'unknown';
        document.getElementById('branch').value = data.branch || 'main';
        document.getElementById('commit_date').value = data.commit_date || new Date().toISOString().split('T')[0];
    })
    .catch(error => {
        alert('Error loading current version: ' + error.message);
    });
}

// Set today's date as default
document.getElementById('commit_date').value = new Date().toISOString().split('T')[0];

// URL extraction function
function extractFromUrl() {
    const url = document.getElementById('url_input').value.trim();
    const resultDiv = document.getElementById('url_result');
    
    if (!url) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a URL</div>';
        return;
    }
    
    // Show loading state
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Extracting version information...</div>';
    
    fetch('/version/extract/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ url: url, auto_set: false })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const extracted = data.extracted_data;
            
            // Validate commit count before populating
            let commitCount = extracted.commit_count;
            if (!commitCount || isNaN(commitCount) || String(commitCount).includes('/')) {
                console.warn(`Invalid commit count from URL extraction: "${commitCount}". Using fallback value 1.`);
                commitCount = 1;
            }
            
            // Populate form fields
            document.getElementById('commit_count').value = parseInt(commitCount);
            document.getElementById('commit_hash').value = extracted.commit_hash || 'unknown';
            document.getElementById('branch').value = extracted.branch || 'main';
            document.getElementById('commit_date').value = extracted.commit_date || new Date().toISOString().split('T')[0];
            
            // Show success message
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>‚úÖ Version Extracted Successfully!</h6>
                    <p class="mb-1"><strong>Version:</strong> ${extracted.version}</p>
                    <p class="mb-1"><strong>Commit:</strong> ${extracted.commit_hash}</p>
                    <p class="mb-1"><strong>Branch:</strong> ${extracted.branch}</p>
                    <p class="mb-1"><strong>Date:</strong> ${extracted.commit_date}</p>
                    ${extracted.commit_message ? `<p class="mb-1"><strong>Message:</strong> ${extracted.commit_message}</p>` : ''}
                    ${extracted.source_url ? `<p class="mb-0"><strong>Source:</strong> <a href="${extracted.source_url}" target="_blank">${extracted.source_url}</a></p>` : ''}
                    <div class="mt-2">
                        <button class="btn btn-success btn-sm" onclick="setVersionFromExtracted()">
                            <i class="fas fa-bolt me-1"></i>Quick Set Version
                        </button>
                    </div>
                </div>
            `;
            
            // Store extracted data for quick set
            window.extractedVersionData = extracted;
            
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>‚ùå Extraction Failed</h6>
                    <p class="mb-1">${data.error}</p>
                    ${data.supported ? `<p class="mb-0"><strong>Supported providers:</strong> ${data.supported.join(', ')}</p>` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>‚ùå Network Error</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    });
}

// Quick set version from extracted data
function setVersionFromExtracted() {
    if (!window.extractedVersionData) return;
    
    const extracted = window.extractedVersionData;
    
    // Validate commit_count before sending
    let commitCount = extracted.commit_count;
    if (!commitCount || isNaN(commitCount) || String(commitCount).includes('/')) {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Validation Error</h6>
                <p class="mb-0">Invalid commit count from extracted data: "${commitCount}"</p>
            </div>
        `;
        return;
    }
    
    // Ensure it's a positive integer
    commitCount = parseInt(commitCount);
    if (commitCount <= 0) {
        commitCount = 1;
    }
    
    // Show loading state
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>Setting version...</div>';
    
    fetch('/version/set/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            commit_count: commitCount,
            commit_hash: extracted.commit_hash,
            branch: extracted.branch,
            commit_date: extracted.commit_date
        })
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('result');
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ Version Set Successfully!</h6>
                    <p class="mb-1"><strong>Version:</strong> ${data.version_info.version}</p>
                    <p class="mb-1"><strong>Commit:</strong> ${data.version_info.commit_hash}</p>
                    <p class="mb-1"><strong>Branch:</strong> ${data.version_info.branch}</p>
                    <p class="mb-1"><strong>Date:</strong> ${data.version_info.commit_date}</p>
                    <p class="mb-0"><strong>Full:</strong> ${data.version_info.full_version}</p>
                </div>
            `;
            
            // Clear URL input and results
            document.getElementById('url_input').value = '';
            document.getElementById('url_result').innerHTML = '';
            
            // Refresh page after 3 seconds to show new version
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6>‚ùå Error Setting Version</h6>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <h6>‚ùå Network Error</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    });
}

// Add Enter key support for URL input
document.getElementById('url_input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        extractFromUrl();
    }
});
</script>
{% endblock %}
