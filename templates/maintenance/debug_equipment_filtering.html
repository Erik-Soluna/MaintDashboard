{% extends 'base.html' %}
{% load static %}

{% block title %}Debug Equipment Filtering{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Debug Equipment Filtering</h1>
                <div class="btn-group" role="group">
                    <a href="{% url 'maintenance:maintenance_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Maintenance
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Equipment Filtering Debug Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Site Selection</h6>
                            {% if selected_site %}
                                <p><strong>Selected Site:</strong> {{ selected_site.name }} (ID: {{ selected_site.id }})</p>
                            {% else %}
                                <p><strong>Selected Site:</strong> All Sites</p>
                            {% endif %}
                            <p><strong>Session Site ID:</strong> {{ selected_site_id|default:"None" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Equipment Counts</h6>
                            <p><strong>Total Equipment (ALL, no filter):</strong> {{ total_equipment_all }}</p>
                            <p><strong>Total Equipment (is_active=True):</strong> {{ total_equipment_active }}</p>
                            <p><strong>Old Method (1 level):</strong> {{ old_filtered_count }}</p>
                            <p><strong>New Method (recursive):</strong> {{ new_filtered_count }}</p>
                            <p><strong>Difference (New - Old):</strong> {{ new_filtered_count|add:"-"|add:old_filtered_count }}</p>
                            <p class="text-danger"><strong>Missing Equipment:</strong> {{ total_equipment_all|add:"-"|add:total_equipment_active }} (inactive equipment)</p>
                        </div>
                    </div>

                    {% if diagnostics %}
                    <hr>
                    <h6>Diagnostics</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><strong>Equipment with NULL location:</strong> {{ diagnostics.equipment_with_null_location }}</li>
                                <li><strong>Equipment with inactive location:</strong> {{ diagnostics.equipment_with_inactive_location }}</li>
                                <li><strong>Max location hierarchy depth:</strong> {{ diagnostics.location_hierarchy_depth.max|default:"0" }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Equipment by location status (sample of 100):</strong>
                            <ul>
                                {% for status, count in diagnostics.equipment_by_location_status.items %}
                                <li>{{ status }}: {{ count }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    {% if selected_site and location_ids %}
                    <hr>
                    <h6>Location IDs Included ({{ location_ids|length }} total)</h6>
                    <p class="small text-muted">First 50 location IDs: {{ location_ids|slice:":50"|join:", " }}{% if location_ids|length > 50 %}... (and {{ location_ids|length|add:"-50" }} more){% endif %}</p>
                    
                    <h6>Raw Location Hierarchy (from database)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Parent ID</th>
                                    <th>Active</th>
                                    <th>Is Site</th>
                                    <th>Depth</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loc in raw_location_hierarchy %}
                                <tr>
                                    <td>{{ loc.0 }}</td>
                                    <td>{{ loc.1 }}</td>
                                    <td>{{ loc.2|default:"None" }}</td>
                                    <td>{% if loc.3 %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-warning">No</span>{% endif %}</td>
                                    <td>{% if loc.4 %}<span class="badge bg-info">Yes</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td>
                                    <td>{{ loc.5 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <h6>Equipment Count by Location</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Location ID</th>
                                    <th>Location Name</th>
                                    <th>Equipment Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for loc in equipment_by_location %}
                                <tr class="{% if loc.2 == 0 %}table-warning{% endif %}">
                                    <td>{{ loc.0 }}</td>
                                    <td>{{ loc.1 }}</td>
                                    <td><strong>{% if loc.2 == 0 %}<span class="text-danger">0 ⚠️</span>{% else %}{{ loc.2 }}{% endif %}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <h6>All Equipment Location Check (Diagnostic)</h6>
                    <p class="small text-muted">This shows every active equipment item and whether its location_id is in our filter list</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Equipment Name</th>
                                    <th>Location ID</th>
                                    <th>Location Name</th>
                                    <th>Location Active</th>
                                    <th>In Filter?</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in all_equipment_location_check %}
                                <tr class="{% if not eq.6 %}table-danger{% endif %}">
                                    <td>{{ eq.0 }}</td>
                                    <td>{{ eq.1 }}</td>
                                    <td>{{ eq.2|default:"NULL" }}</td>
                                    <td>{{ eq.3|default:"NULL" }}</td>
                                    <td>{% if eq.5 %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-warning">No</span>{% endif %}</td>
                                    <td>
                                        {% if eq.6 %}
                                            <span class="badge bg-success">Yes</span>
                                        {% else %}
                                            <span class="badge bg-danger">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if equipment_not_in_filter %}
                    <h6>Equipment NOT in Filter (Location ID mismatch)</h6>
                    <p class="text-danger">These equipment items are active but their location_id is NOT in our location_ids list</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-danger">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Equipment Name</th>
                                    <th>Location ID</th>
                                    <th>Location Name</th>
                                    <th>Parent Location ID</th>
                                    <th>Parent Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment_not_in_filter %}
                                <tr>
                                    <td>{{ eq.0 }}</td>
                                    <td><strong>{{ eq.1 }}</strong></td>
                                    <td>{{ eq.2|default:"NULL" }}</td>
                                    <td>{{ eq.3|default:"NULL" }}</td>
                                    <td>{{ eq.4|default:"NULL" }}</td>
                                    <td>{{ eq.5|default:"NULL" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if equipment_in_duplicate_pods %}
                    <h6>⚠️ CRITICAL: Equipment in PODs with Same Name but Different Site</h6>
                    <p class="text-danger"><strong>ROOT CAUSE FOUND:</strong> These equipment items are in PODs with the same name as Dorothy 1A PODs, but they belong to OTHER sites. This is why they're not showing up in the filter!</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-danger">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Equipment Name</th>
                                    <th>Current Location ID</th>
                                    <th>Current Location Name</th>
                                    <th>Current Site</th>
                                    <th>Should Be In POD</th>
                                    <th>Target POD ID</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in equipment_in_duplicate_pods %}
                                <tr>
                                    <td>{{ eq.0 }}</td>
                                    <td><strong>{{ eq.1 }}</strong></td>
                                    <td>{{ eq.2 }}</td>
                                    <td>{{ eq.3 }}</td>
                                    <td><span class="badge bg-warning">{{ eq.5 }} (Site ID: {{ eq.6 }})</span></td>
                                    <td><span class="badge bg-info">{{ eq.7 }}</span></td>
                                    <td><span class="badge bg-success">{{ eq.8 }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-warning">
                        <strong>Solution:</strong> These equipment items need to be reassigned from their current POD locations (which belong to other sites) to the Dorothy 1A POD locations with the same names. The POD names are the same, but they are different location records!
                    </div>
                    {% endif %}
                    
                    <h6>All Equipment with Actual Site Assignment</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Equipment ID</th>
                                    <th>Equipment Name</th>
                                    <th>Location ID</th>
                                    <th>Location Name</th>
                                    <th>Location Active</th>
                                    <th>Actual Site ID</th>
                                    <th>In Filter</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eq in all_equipment_with_sites %}
                                <tr>
                                    <td>{{ eq.0 }}</td>
                                    <td>{{ eq.1 }}</td>
                                    <td>{{ eq.2|default:"NULL" }}</td>
                                    <td>{{ eq.3|default:"NULL" }}</td>
                                    <td>{% if eq.5 %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-warning">No</span>{% endif %}</td>
                                    <td>{{ eq.6|default:"NULL" }}</td>
                                    <td>
                                        {% if eq.6 == selected_site.id %}
                                            <span class="badge bg-success">Yes</span>
                                        {% else %}
                                            <span class="badge bg-danger">No (Site: {{ eq.6|default:"None" }})</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    {% if old_query_sql or new_query_sql %}
                    <hr>
                    <h6>SQL Queries</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Old Method Query:</strong>
                            <pre class="bg-light p-2 small">{{ old_query_sql|truncatewords:50 }}</pre>
                        </div>
                        <div class="col-md-6">
                            <strong>New Method Query:</strong>
                            <pre class="bg-light p-2 small">{{ new_query_sql|truncatewords:50 }}</pre>
                        </div>
                    </div>
                    {% endif %}

                    <hr>
                    <h6>All Sites</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Site Name</th>
                                    <th>ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for site in all_sites %}
                                <tr>
                                    <td>{{ site.name }}</td>
                                    <td>{{ site.id }}</td>
                                    <td>
                                        <a href="?site_id={{ site.id }}" class="btn btn-sm btn-primary">Debug This Site</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <hr>
                    <h6>All Equipment (showing first 100)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Equipment Name</th>
                                    <th>Category</th>
                                    <th>Location</th>
                                    <th>Location Active</th>
                                    <th>Site</th>
                                    <th>In Old Filter</th>
                                    <th>In New Filter</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipment in all_equipment|slice:":100" %}
                                <tr>
                                    <td>{{ equipment.id }}</td>
                                    <td>{{ equipment.name }}</td>
                                    <td>{{ equipment.category.name|default:"N/A" }}</td>
                                    <td>
                                        {% if equipment.location %}
                                            {{ equipment.location.name }} (ID: {{ equipment.location.id }})
                                        {% else %}
                                            <span class="text-danger">NULL</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if equipment.location %}
                                            {% if equipment.location.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-warning">Inactive</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if equipment.location %}
                                            {% if equipment.location.is_site %}
                                                {{ equipment.location.name }}
                                            {% elif equipment.location.parent_location %}
                                                {{ equipment.location.parent_location.name }}
                                            {% else %}
                                                <span class="text-muted">No site</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-danger">No location</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if selected_site %}
                                            {% if equipment in old_filtered_equipment %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-danger">No</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if selected_site %}
                                            {% if equipment in new_filtered_equipment %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-danger">No</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if total_equipment > 100 %}
                    <p class="text-muted">Showing first 100 of {{ total_equipment }} total equipment items.</p>
                    {% endif %}

                    {% if selected_site %}
                    <hr>
                    <h6>Missing Equipment Analysis</h6>
                    <p>Equipment in NEW filter but not in OLD filter:</p>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Equipment Name</th>
                                    <th>Location</th>
                                    <th>Location Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipment in new_filtered_equipment %}
                                    {% if equipment not in old_filtered_equipment %}
                                    <tr>
                                        <td>{{ equipment.name }}</td>
                                        <td>{{ equipment.location.name|default:"NULL" }}</td>
                                        <td>{{ equipment.location.get_full_path|default:"N/A" }}</td>
                                    </tr>
                                    {% endif %}
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No differences found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
