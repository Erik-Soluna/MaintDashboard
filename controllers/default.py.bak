# File: controllers/default.py
# -*- coding: utf-8 -*-
"""
Default controller providing the Dashboard, user authentication, and functions
to manage alerts, attachments, logs, and site filtering.
"""

import logging
from gluon import redirect, URL, T, SQLFORM

logging.basicConfig(level=logging.DEBUG)

def index():
    """Dashboard landing page."""
    if not auth.user:
        redirect(URL('user', args='login'))
    return dict(message="Welcome to the Maintenance Management System!")

def user():
    """Handles authentication (login, logout, register, etc.)."""
    return dict(form=auth())

@auth.requires_login()
def manage_alerts():
    """Manage alerts with a CRUD interface."""
    grid = SQLFORM.grid(db.alerts,
                        create=True, editable=True, deletable=True, csv=True)
    return dict(grid=grid)

@auth.requires_login()
def manage_attachments():
    """Manage equipment attachments with a CRUD interface."""
    grid = SQLFORM.grid(db.attachments,
                        create=True, editable=True, deletable=True, csv=True)
    return dict(grid=grid)

@auth.requires_login()
def manage_action_logs():
    """View action logs (read-only)."""
    grid = SQLFORM.grid(db.action_logs, create=False, editable=False,
                        deletable=False, csv=True)
    return dict(grid=grid)

@auth.requires_login()
def set_site_filter():
    """Set the selected site location as the active session filter."""
    site_id = request.vars.get('site_id')
    if site_id and db.site_location(site_id):
        session.site_filter = site_id
        response.flash = "Site location updated."
        logging.debug(f"Site filter set to: {site_id}")
    else:
        response.flash = "Invalid site location."
        logging.warning("Attempted to set invalid site location.")
    redirect(request.env.http_referer or URL('default', 'index'))
