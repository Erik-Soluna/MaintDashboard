# Recurring Maintenance Feature Guide

## Overview

The maintenance dashboard now supports optional recurring maintenance schedules. Instead of automatically generating schedules on boot, users can now choose to make a maintenance activity recurring when they create it.

## Changes Made

### 1. Removed Automatic Schedule Generation on Boot
- **File Modified**: `scripts/deployment/docker-entrypoint.sh`
- **Change**: Removed the automatic call to `generate_initial_schedules` during container startup
- **Impact**: Schedules are no longer automatically created for all equipment on boot, giving users more control

### 2. Added Recurring Options to Maintenance Activity Form
- **File Modified**: `maintenance/forms.py`
- **New Fields**:
  - `make_recurring`: Checkbox to enable recurring maintenance
  - `recurrence_frequency`: Dropdown for frequency (Daily, Weekly, Monthly, Quarterly, Semi-Annual, Annual, Custom)
  - `recurrence_frequency_days`: Custom frequency in days (shown only when "Custom" is selected)
  - `recurrence_end_date`: Optional end date for the recurring schedule
  - `recurrence_advance_notice_days`: How many days in advance to generate future activities (default: 7)

### 3. Updated Form Save Logic
- **File Modified**: `maintenance/forms.py` - `MaintenanceActivityForm.save()` method
- **Behavior**: When "Make this a recurring activity" is checked:
  1. The maintenance activity is created as usual
  2. A `MaintenanceSchedule` is automatically created (or updated) for the equipment and activity type
  3. The schedule uses the frequency and settings specified in the form

### 4. Updated Add Activity Template
- **File Modified**: `templates/maintenance/add_activity.html`
- **Change**: Now uses crispy forms rendering to automatically display all form fields including the new recurring options
- **UI**: Recurring options appear in a collapsible section that shows/hides based on the checkbox

## How to Use

### Creating a One-Time Maintenance Activity
1. Navigate to **Maintenance** → **Add Activity**
2. Fill in the activity details (equipment, type, schedule, etc.)
3. Leave the "Make this a recurring activity" checkbox **unchecked**
4. Click **Save Activity**

### Creating a Recurring Maintenance Activity
1. Navigate to **Maintenance** → **Add Activity**
2. Fill in the activity details (equipment, type, schedule, etc.)
3. **Check** the "Make this a recurring activity" checkbox
4. Select a frequency:
   - **Daily**: Repeats every day
   - **Weekly**: Repeats every 7 days
   - **Monthly**: Repeats every 30 days
   - **Quarterly**: Repeats every 90 days
   - **Semi-Annual**: Repeats every 180 days
   - **Annual**: Repeats every 365 days
   - **Custom**: Specify your own frequency in days
5. (Optional) Set an end date for the recurring schedule
6. (Optional) Adjust the advance notice days (how far ahead to generate future activities)
7. Click **Save Activity**

### What Happens After Creating a Recurring Activity

1. The first maintenance activity is created with the date/time you specified
2. A maintenance schedule is created in the background
3. Future maintenance activities will be automatically generated by:
   - The periodic Celery task `generate_scheduled_maintenance` (runs automatically)
   - The management command `python manage.py generate_scheduled_activities` (can be run manually or via cron)

## Automatic Generation of Future Activities

The system will automatically create future maintenance activities based on your recurring schedules using:

### Option 1: Celery Task (Recommended for Production)
- **Task**: `generate_scheduled_maintenance`
- **Frequency**: Configured in your Celery beat schedule
- **File**: `maintenance/tasks.py`
- This runs automatically in the background when Celery is configured

### Option 2: Management Command (Manual or Cron)
- **Command**: `python manage.py generate_scheduled_activities`
- **Options**:
  - `--days-ahead 30`: Generate activities for the next 30 days (default)
  - `--equipment-id <id>`: Generate only for specific equipment
  - `--activity-type-id <id>`: Generate only for specific activity type
  - `--dry-run`: Preview what would be generated without creating activities

**Example**:
```bash
# Generate activities for the next 60 days
python manage.py generate_scheduled_activities --days-ahead 60

# Preview what would be generated
python manage.py generate_scheduled_activities --dry-run
```

## Managing Existing Schedules

You can still manage maintenance schedules directly:
- Navigate to **Maintenance** → **Schedules**
- View, edit, or delete existing schedules
- Manually create schedules for bulk equipment

## Benefits of This Approach

1. **User Control**: Users decide which maintenance should be recurring
2. **No Automatic Clutter**: System doesn't create schedules for all equipment on boot
3. **Flexible Scheduling**: Each maintenance activity can have its own recurrence pattern
4. **Easy to Understand**: Recurring options are right in the activity creation form
5. **Backward Compatible**: Existing scheduling system still works

## Troubleshooting

### Future Activities Not Being Generated
1. Check that the Celery worker is running: `celery -A maintenance_dashboard worker -l info`
2. Check that Celery beat is running: `celery -A maintenance_dashboard beat -l info`
3. Manually run: `python manage.py generate_scheduled_activities` to test
4. Check that the schedule has `auto_generate=True` and `is_active=True`

### Schedule Not Created When Saving Activity
1. Ensure "Make this a recurring activity" checkbox is checked
2. Ensure a frequency is selected
3. For custom frequency, ensure the number of days is specified
4. Check the form validation messages for any errors

## Technical Details

### Database Models
- **MaintenanceActivity**: Individual maintenance tasks
- **MaintenanceSchedule**: Defines recurring patterns for maintenance
- **Relationship**: One schedule can generate many activities over time

### Schedule Generation Logic
- Schedules check if activities already exist before creating duplicates
- Activities are generated up to `advance_notice_days` in advance
- Generation respects the `end_date` if specified
- Tracks `last_generated` date to avoid redundant generation

